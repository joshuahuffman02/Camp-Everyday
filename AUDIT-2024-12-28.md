# Campreserv Deep Audit Report
**Date:** 2024-12-28
**Status:** üîÑ In Progress
**Total Issues Found:** 256
**Fixed:** 11 | **Remaining:** 245

---

## Executive Summary

Comprehensive audit performed using 6 specialized agents analyzing security, database patterns, API endpoints, frontend code, and performance. Found critical multi-tenant isolation issues, missing authentication guards, and several potential data leaks.

---

## Progress Tracker

| Category | Total | Fixed | Remaining | Status |
|----------|-------|-------|-----------|--------|
| Security (Critical) | 5 | 5 | 0 | ‚úÖ |
| Security (High) | 6 | 1 | 5 | üîÑ |
| Security (Medium) | 7 | 0 | 7 | ‚è≥ |
| Database/Prisma | 28 | 5 | 23 | üîÑ |
| API Endpoints | 42 | 0 | 42 | ‚è≥ |
| Frontend | 149 | 0 | 149 | ‚è≥ |
| Performance | 14 | 0 | 14 | ‚è≥ |

---

## Phase 1: Critical Security Fixes (Priority: IMMEDIATE)

### SEC-CRIT-001: Multi-Tenant Data Leak in Stored Value Service ‚úÖ
- **File:** `platform/apps/api/src/stored-value/stored-value.service.ts:37-67`
- **Issue:** `findUnique` by ID without verifying `campgroundId` matches scope
- **Impact:** User from Campground A can reload stored value account from Campground B
- **Status:** ‚úÖ Fixed
- **Fixed:** Added campground ownership validation with ForbiddenException

### SEC-CRIT-002: Missing Auth on Public Reservation Endpoints ‚úÖ
- **File:** `platform/apps/api/src/public-reservations/public-reservations.controller.ts`
- **Issue:** `/public/reservations/:id` and `/kiosk-checkin` have NO authentication
- **Impact:** Any user can access ANY reservation by guessing IDs (IDOR)
- **Status:** ‚úÖ Fixed
- **Fixed:** Added @Throttle rate limiting, campgroundId validation, and service-layer ownership checks

### SEC-CRIT-003: IDOR in Sites Controller ‚úÖ
- **File:** `platform/apps/api/src/sites/sites.controller.ts:39-46`
- **Issue:** Update/delete endpoints don't verify campground ownership
- **Impact:** User can modify/delete sites from other campgrounds
- **Status:** ‚úÖ Fixed
- **Fixed:** Added RolesGuard, ScopeGuard, campground ownership validation, missing @Get decorator

### SEC-CRIT-004: Guest Controller Missing Campground Isolation ‚úÖ
- **File:** `platform/apps/api/src/guests/guests.controller.ts:45-62`
- **Issue:** Update/delete accept optional `campgroundId`, don't enforce before modification
- **Impact:** User can update guests from other campgrounds
- **Status:** ‚úÖ Fixed
- **Fixed:** Made campgroundId required on PATCH/DELETE with ForbiddenException

### SEC-CRIT-005: CORS Allows Wildcard Patterns ‚úÖ
- **File:** `platform/apps/api/src/app.bootstrap.ts:46-65`
- **Issue:** `origin.includes("ngrok")` allows `evilsite.ngrok.io`
- **Impact:** Attacker domains can make authenticated cross-origin requests
- **Status:** ‚úÖ Fixed
- **Fixed:** Rewrote CORS to use strict URL parsing with hostname.endsWith() checks

---

## Phase 2: High Security Fixes

### SEC-HIGH-001: JWT Secret Fallback to Weak Default ‚úÖ
- **File:** `platform/apps/api/src/auth/strategies/jwt.strategy.ts:18`
- **Issue:** Falls back to `'dev-secret-change-me'` if env not set
- **Impact:** All tokens forgeable if deployed without JWT_SECRET
- **Status:** ‚úÖ Fixed
- **Fixed:** Throws error in production if JWT_SECRET not set; uses random secret in dev (tokens don't persist)

### SEC-HIGH-002: ScopeGuard Skips Validation Without Header
- **File:** `platform/apps/api/src/auth/guards/scope.guard.ts:50-56`
- **Issue:** Returns `true` when no `X-Campground-Id` header provided
- **Impact:** Endpoints can be called without campground scope
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### SEC-HIGH-003: Bootstrap Admin Bypasses Security Controls
- **File:** `platform/apps/api/src/auth/auth.service.ts:84-107`
- **Issue:** Any email/password creates platform admin when no users exist
- **Impact:** Race condition, no password complexity during bootstrap
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### SEC-HIGH-004: Sites Service Missing Campground Validation ‚úÖ
- **File:** `platform/apps/api/src/sites/sites.service.ts:43-53`
- **Issue:** Update destructures `campgroundId` but doesn't use for validation
- **Impact:** User can change any site's data
- **Status:** ‚úÖ Fixed (already had null checks)
- **Fixed:** Service has NotFoundException checks; SEC-CRIT-003 fix adds controller-level ownership validation

### SEC-HIGH-005: Stripe Account ID Used Without Validation
- **File:** `platform/apps/api/src/payments/payments.controller.ts:172, 592`
- **Issue:** `stripeAccountId` cast without null check
- **Impact:** Payments fail ungracefully or go to wrong account
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### SEC-HIGH-006: Console.log Leaks Sensitive Data
- **Files:** 45+ files across API
- **Issue:** Extensive `console.log` with PII (emails, auth attempts)
- **Impact:** Sensitive data in logs
- **Status:** üîÑ In Progress (agent running)
- **Fixed:** Refactorer agent replacing console.* with NestJS Logger

---

## Phase 3: Database/Prisma Fixes

### DB-CRIT-001: Missing Composite Index on Reservation ‚úÖ
- **File:** `platform/apps/api/prisma/schema.prisma:2297-2301`
- **Issue:** Missing `(campgroundId, status, arrivalDate, departureDate)` index
- **Impact:** Availability queries scan entire table
- **Status:** ‚úÖ Fixed
- **Fixed:** Added composite indexes for Reservation, Payment, LedgerEntry, RepeatCharge, MaintenanceTicket

### DB-CRIT-002: N+1 Query in Reservation Import
- **File:** `platform/apps/api/src/data-import/reservation-import.service.ts:253-283`
- **Issue:** 3+ queries per row in loop
- **Impact:** 100 reservations = 300+ queries
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### DB-CRIT-003: Guest emailNormalized Not Unique
- **File:** `platform/apps/api/prisma/schema.prisma:2084-2086`
- **Issue:** `@@unique([email])` on non-normalized field
- **Impact:** Guest deduplication fails, `john@email.com` and `JOHN@EMAIL.COM` create duplicates
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### DB-HIGH-001: No Connection Pool Configuration
- **File:** `platform/apps/api/src/prisma/prisma.service.ts:12`
- **Issue:** No pool size, timeout, or connection limits
- **Impact:** Connection exhaustion under load
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### DB-MED-001: Missing Payment Indexes ‚úÖ
- **File:** `platform/apps/api/prisma/schema.prisma:2558-2565`
- **Issue:** Missing `(campgroundId, createdAt)` and `(campgroundId, capturedAt)`
- **Impact:** Financial reports scan full table
- **Status:** ‚úÖ Fixed
- **Fixed:** Added `@@index([campgroundId, createdAt])`, `@@index([campgroundId, capturedAt])`, `@@index([reservationId, direction])`

### DB-MED-002: Missing LedgerEntry Indexes ‚úÖ
- **File:** `platform/apps/api/prisma/schema.prisma:2790-2822`
- **Issue:** Missing `(campgroundId, glCode, createdAt)`
- **Impact:** Accounting reports slow
- **Status:** ‚úÖ Fixed
- **Fixed:** Added `@@index([campgroundId, createdAt])`, `@@index([campgroundId, glCode, createdAt])`, `@@index([reservationId, createdAt])`

---

## Phase 4: API Endpoint Fixes

### API-CRIT-001: Missing Null Checks in Flex-Check Service
- **File:** `platform/apps/api/src/flex-check/flex-check.service.ts:140, 250`
- **Issue:** `denyEarlyCheckIn` and `denyLateCheckout` update without existence check
- **Impact:** Prisma P2025 error instead of clean 404
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### API-CRIT-002: Missing Null Checks in Sites Service
- **File:** `platform/apps/api/src/sites/sites.service.ts`
- **Issue:** `findOne`, `update`, `remove` don't validate existence
- **Impact:** Ungraceful errors
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### API-CRIT-003: Payment Not Atomic with Reservation Update
- **File:** `platform/apps/api/src/payments/payments.controller.ts:628-654`
- **Issue:** Creates payment and updates reservation separately
- **Impact:** Inconsistent state on failure
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### API-CRIT-004: Missing DTO Validation on Payment DTOs
- **File:** `platform/apps/api/src/payments/payments.controller.ts:24-68`
- **Issue:** `CreatePublicPaymentIntentDto`, `RefundPaymentIntentDto` lack decorators
- **Impact:** Invalid data reaches service layer
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### API-CRIT-005: Missing Role Guards on Campground Delete
- **File:** `platform/apps/api/src/campgrounds/campgrounds.controller.ts:349-353`
- **Issue:** No role restrictions on DELETE
- **Impact:** Any authenticated user can delete campground
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### API-MED-001: Store Controller Uses Error Instead of Exceptions
- **File:** `platform/apps/api/src/store/store.controller.ts:185-207`
- **Issue:** `throw new Error()` instead of `BadRequestException`
- **Impact:** 500 errors instead of proper 400s
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### API-MED-002: Inconsistent Async/Await in Controllers
- **Files:** Multiple controllers
- **Issue:** Some methods async, others not
- **Impact:** Race conditions, inconsistent behavior
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

---

## Phase 5: Frontend Fixes

### FE-CRIT-001: No Error Boundaries
- **Files:** App-wide
- **Issue:** No React error boundaries
- **Impact:** Unhandled errors crash entire app
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### FE-CRIT-002: Silent Error Swallowing
- **File:** `platform/apps/web/components/reservations/MessagesPanel.tsx:54`
- **Issue:** `.catch(console.error)` with no user feedback
- **Impact:** User unaware of failures
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### FE-CRIT-003: Memory Leak in SyncStatusContext
- **File:** `platform/apps/web/contexts/SyncStatusContext.tsx:194-198`
- **Issue:** Interval not properly cleaned when `refresh` changes
- **Impact:** Memory leak, multiple intervals running
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### FE-CRIT-004: Stale Closure in Waitlist
- **File:** `platform/apps/web/app/waitlist/page.tsx:106-112`
- **Issue:** `statusFilter` in deps but also set in effect
- **Impact:** Potential infinite re-renders
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### FE-HIGH-001: 47 Instances of `as any`
- **Files:** Multiple
- **Issue:** Type safety bypassed
- **Impact:** Runtime errors not caught by TypeScript
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### FE-MED-001: Stubbed Payment Features Showing Errors
- **File:** `platform/apps/web/components/payments/PaymentCollectionModal/hooks/useGiftCard.ts:54-58`
- **Issue:** Returns error "Gift card payments not yet available"
- **Impact:** Confusing UX
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### FE-MED-002: Alert() Instead of Proper UI
- **File:** `platform/apps/web/components/reservations/ReservationFormsCard.tsx:372`
- **Issue:** `alert("Send reminder email - TODO")`
- **Impact:** Poor UX, breaks SSR if triggered
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### FE-LOW-001: Debug Code in Production
- **Files:** `lib/blog.ts`, `KeyboardShortcutsContext.tsx`
- **Issue:** `DEBUG_LOGS` array, `window.__keyboardShortcuts`
- **Impact:** Memory waste, global pollution
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

---

## Phase 6: Performance Fixes

### PERF-CRIT-001: N+1 in Guest Export
- **File:** `platform/apps/web/app/guests/page.tsx:388-395`
- **Issue:** `Promise.all(guests.map(async g => getLoyaltyProfile(g.id)))`
- **Impact:** 500 guests = 500 API calls
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### PERF-CRIT-002: Dashboard Computes 4x Per Render
- **File:** `platform/apps/web/app/dashboard/page.tsx:352-425`
- **Issue:** Multiple `useMemo` each filtering all reservations
- **Impact:** 2000 reservations = 28,000 filter operations
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### PERF-HIGH-001: AI Dashboard 8 Parallel Queries
- **File:** `platform/apps/api/src/ai/ai-dashboard.service.ts:34-147`
- **Issue:** 8 concurrent queries for 10 records each
- **Impact:** Connection pool exhaustion
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### PERF-MED-001: Heavy Libraries Not Code-Split
- **File:** `platform/apps/web/package.json`
- **Issue:** maplibre (560KB), recharts (430KB) bundled everywhere
- **Impact:** Slow initial load
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

### PERF-MED-002: In-Memory Caches Unbounded
- **Files:** Multiple services
- **Issue:** `new Map()` without size limits
- **Impact:** Memory leak in long-running processes
- **Status:** ‚è≥ Pending
- **Fixed:** N/A

---

## Fix Log

| Date | Issue ID | File | Change Summary | Commit |
|------|----------|------|----------------|--------|
| 2024-12-28 | SEC-CRIT-001 | stored-value.service.ts | Added campground ownership validation | Pending |
| 2024-12-28 | SEC-CRIT-002 | public-reservations.controller.ts | Added rate limiting + campgroundId validation | Pending |
| 2024-12-28 | SEC-CRIT-002 | public-reservations.service.ts | Added campgroundId param to service methods | Pending |
| 2024-12-28 | SEC-CRIT-003 | sites.controller.ts | Added guards, roles, ownership checks | Pending |
| 2024-12-28 | SEC-CRIT-004 | guests.controller.ts | Required campgroundId on mutations | Pending |
| 2024-12-28 | SEC-CRIT-005 | app.bootstrap.ts | Rewrote CORS with strict URL parsing | Pending |
| 2024-12-28 | DB-CRIT-001 | schema.prisma | Added composite indexes to 5 models | Pending |
| 2024-12-28 | DB-MED-001 | schema.prisma | Added Payment indexes | Pending |
| 2024-12-28 | DB-MED-002 | schema.prisma | Added LedgerEntry indexes | Pending |

---

## Next Steps

1. **Phase 1:** Fix all Critical Security issues (SEC-CRIT-*)
2. **Phase 2:** Fix High Security issues (SEC-HIGH-*)
3. **Phase 3:** Add missing database indexes and fix Prisma patterns
4. **Phase 4:** Fix API endpoint issues (null checks, guards, DTOs)
5. **Phase 5:** Add error boundaries and fix frontend issues
6. **Phase 6:** Address performance optimizations

---

*Last Updated: 2024-12-28 (Phase 1 Complete, Phase 2-3 In Progress)*

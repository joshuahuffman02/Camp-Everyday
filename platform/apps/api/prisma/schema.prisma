generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PLATFORM_DATABASE_URL")
}

enum ReservationStatus {
  pending
  confirmed
  checked_in
  checked_out
  cancelled
}

enum SiteType {
  rv
  tent
  cabin
  group
  glamping
}

enum MaintenanceStatus {
  open
  in_progress
  closed
}

enum MaintenancePriority {
  low
  medium
  high
  critical
}

enum CampaignStatus {
  draft
  scheduled
  sending
  sent
  cancelled
}

enum CampaignSendStatus {
  queued
  sent
  failed
  unsubscribed
}

enum SupportReportStatus {
  new
  triage
  in_progress
  resolved
  closed
}

enum ChannelType {
  email
  sms
  both
}

enum UserRole {
  owner
  manager
  front_desk
  maintenance
  finance
  marketing
  readonly
}

enum SenderType {
  guest
  staff
}

enum TaxRuleType {
  percentage
  flat
  exemption
}

enum RateType {
  nightly
  weekly
  monthly
  seasonal
}

enum StayType {
  standard
  weekly
  monthly
  seasonal
}

enum PaymentSchedule {
  single
  weekly
  monthly
  as_you_stay
  offseason_installments
}

enum PricingStructure {
  per_night
  flat_week
  flat_month
  flat_season
}

enum ChargeStatus {
  pending
  paid
  failed
}

// Phase 2 housekeeping/maintenance/group bookings
enum TaskType {
  turnover
  inspection
  other
}

enum TaskState {
  pending
  in_progress
  blocked
  done
  failed
  expired
}

enum SlaStatus {
  on_track
  at_risk
  breached
}

enum TicketState {
  open
  in_progress
  blocked
  resolved
  reopened
  closed
}

enum Severity {
  low
  med
  high
  critical
}

enum CheckInStatus {
  not_started
  pending_id
  pending_payment
  pending_waiver
  pending_site_ready
  completed
  failed
}

enum CheckOutStatus {
  not_started
  pending_review
  completed
  failed
}

enum GroupRole {
  primary
  member
}

// ---------------------------------------------------------------------------
// Social Media Planner enums
// ---------------------------------------------------------------------------

enum SocialPlatform {
  facebook
  instagram
  tiktok
  email
  blog
}

enum SocialPostStatus {
  draft
  scheduled
  needs_image
  needs_approval
  ready
  completed
  dismissed
}

enum SocialContentCategory {
  amenities
  events
  offers
  reviews
  tips
  general
  promo
}

enum SocialTemplateStyle {
  short
  detailed
  story
  carousel
  announce
}

enum SocialAssetType {
  photo
  video
  logo
  template
  other
}

enum SocialSuggestionType {
  idea
  auto
  operator
  occupancy
  event
  deal
  seasonal
}

enum SocialSuggestionStatus {
  new
  accepted
  rejected
  published
}

enum ApprovalStatus {
  pending
  approved
  rejected
}

enum PermissionEffect {
  allow
  deny
}

enum PlatformRole {
  support_agent
  support_lead
  regional_support
  ops_engineer
  platform_admin
}

enum PiiClassification {
  basic
  sensitive
  payment
  secret
}

enum RedactionMode {
  mask
  remove
}

enum ConsentMethod {
  verbal
  written
  digital
}

enum SocialAlertCategory {
  weather
  occupancy
  events
  deals
  reviews
  inactivity
  inventory
}

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  passwordHash   String
  firstName      String
  lastName       String
  region         String?
  platformRole   PlatformRole?
  platformRegion String?
  platformActive Boolean       @default(true)
  ownershipRoles String[]      @default([])
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now()) @updatedAt

  memberships                      CampgroundMembership[]
  maintenanceTickets               MaintenanceTicket[]
  internalMessages                 InternalMessage[]
  internalConversationParticipants InternalConversationParticipant[]
  inviteTokens                     InviteToken[]
  auditLogs                        AuditLog[]
  storeOrdersCompleted             StoreOrder[]
  supportReportsAuthored           SupportReport[]                   @relation("ReportAuthor")
  supportReportsAssigned           SupportReport[]                   @relation("ReportAssignee")
  uploadedAssets                   SocialContentAsset[]              @relation("AssetUploader")
  xpRulesCreated                   XpRule[]                          @relation("XpRuleCreator")
  xpBalances                       XpBalance[]
  xpEvents                         XpEvent[]
  pushSubscriptions                PushSubscription[]
  integrationExportJobs            IntegrationExportJob[]
  auditExports                     AuditExport[]
  piiFieldTags                     PiiFieldTag[]
  approvalPolicies                 ApprovalPolicy[]
  permissionRules                  PermissionRule[]
  approvedCommunicationTemplates   CommunicationTemplate[]           @relation("CommunicationTemplateApprovedBy")

  // Phase 3 relations
  staffShifts         StaffShift[]         @relation("StaffShifts")
  staffAvailability   StaffAvailability[]  @relation("StaffAvailability")
  pushNotifications   PushNotification[]   @relation("PushNotifications")
  staffPerformance    StaffPerformance[]   @relation("StaffPerformance")
  savedReports        SavedReport[]        @relation("SavedReports")
  portfolioDashboards PortfolioDashboard[] @relation("PortfolioDashboards")
}

model GuestEquipment {
  id          String   @id @default(cuid())
  guestId     String
  type        String // rv, trailer, tent, car
  make        String?
  model       String?
  length      Int? // in feet
  plateNumber String?
  plateState  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([guestId])
}

model CampgroundMembership {
  id           String   @id @default(cuid())
  userId       String
  campgroundId String
  role         UserRole
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  xpEvents   XpEvent[]

  @@unique([userId, campgroundId])
  @@index([campgroundId])
}

model SupportReport {
  id             String              @id @default(uuid())
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  description    String
  steps          String?
  contactEmail   String?
  path           String?
  userAgent      String?
  language       String?
  timezone       String?
  viewportWidth  Int?
  viewportHeight Int?
  roleFilter     String?
  pinnedIds      String[]
  recentIds      String[]
  rawContext     Json?
  status         SupportReportStatus @default(new)
  assigneeId     String?
  assignee       User?               @relation("ReportAssignee", fields: [assigneeId], references: [id])
  authorId       String?
  author         User?               @relation("ReportAuthor", fields: [authorId], references: [id])
  campgroundId   String?
  campground     Campground?         @relation("ReportCampground", fields: [campgroundId], references: [id])
}

model SiteClass {
  id                String   @id @default(cuid())
  campgroundId      String
  name              String
  description       String?
  defaultRate       Int      @default(0)
  siteType          SiteType
  maxOccupancy      Int
  rigMaxLength      Int?
  hookupsPower      Boolean  @default(false)
  hookupsWater      Boolean  @default(false)
  hookupsSewer      Boolean  @default(false)
  tags              String[] @default([])
  glCode            String?
  clientAccount     String?
  minNights         Int?
  maxNights         Int?
  petFriendly       Boolean  @default(true)
  accessible        Boolean  @default(false)
  photos            String[] @default([])
  photoAttributions Json?
  policyVersion     String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt

  campground      Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  sites           Site[]
  pricingRules    PricingRule[]
  pricingRulesV2  PricingRuleV2[]
  seasonalRates   SeasonalRate[]
  otaMappings     OtaListingMapping[] @relation("SiteClassOtaMappings")
  analyticsEvents AnalyticsEvent[]
  demandBands     DemandBand[]
  upsellItems     UpsellItem[]
  depositPolicies DepositPolicy[]
  waitlistEntries WaitlistEntry[]

  @@index([campgroundId])
}

enum SubscriptionTier {
  free
  starter
  professional
  enterprise
}

enum BillingPlan {
  ota_only // OTA-only, per-booking fee (default $3)
  standard // Core product, per-booking fee (default $2)
  enterprise // Flat monthly + low per-booking fee (default $1 + monthly)
}

enum PaymentFeeMode {
  absorb // Platform fee is absorbed by campground (reduces payout)
  pass_through // Platform fee added to guest total
}

enum NpsSurveyStatus {
  draft
  active
  paused
  archived
}

enum NpsInviteStatus {
  queued
  sent
  bounced
  opened
  responded
  expired
}

enum ReviewStatus {
  pending
  approved
  rejected
  removed
}

enum ReviewSource {
  onsite
  email
  sms
  kiosk
  import
}

enum ReviewExposure {
  private
  public
}

enum ReviewVoteValue {
  helpful
  not_helpful
}

enum ReviewModerationStatus {
  pending
  approved
  rejected
}

// =============================================================================
// Analytics & Data Intelligence
// =============================================================================

enum AnalyticsEventName {
  page_view
  site_card_view
  image_viewed
  image_hovered
  image_clicked
  site_class_viewed
  availability_check
  add_to_stay
  reservation_start
  reservation_abandoned
  reservation_completed
  deal_viewed
  deal_applied
  email_signup
  review_viewed
  admin_pricing_change
  admin_image_reorder
}

enum AbTestStatus {
  draft
  active
  paused
  stopped
  completed
}

model AnalyticsEvent {
  id             String             @id @default(cuid())
  campgroundId   String?
  organizationId String?
  reservationId  String?
  siteId         String?
  siteClassId    String?
  promotionId    String?
  imageId        String?
  sessionId      String
  eventName      AnalyticsEventName
  page           String?
  referrer       String?
  referrerUrl    String?
  deviceType     String?
  region         String?
  abVariantId    String?
  metadata       Json?
  occurredAt     DateTime           @default(now())
  createdAt      DateTime           @default(now())

  campground   Campground?   @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  reservation  Reservation?  @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  site         Site?         @relation(fields: [siteId], references: [id], onDelete: SetNull)
  siteClass    SiteClass?    @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  promotion    Promotion?    @relation(fields: [promotionId], references: [id], onDelete: SetNull)
  abVariant    AbVariant?    @relation(fields: [abVariantId], references: [id], onDelete: SetNull)

  @@index([campgroundId, occurredAt])
  @@index([organizationId, occurredAt])
  @@index([sessionId, occurredAt])
  @@index([eventName, occurredAt])
  @@index([siteId])
  @@index([siteClassId])
  @@index([promotionId])
  @@index([abVariantId])
}

model AnalyticsDailyAggregate {
  id             String             @id @default(cuid())
  campgroundId   String?
  organizationId String?
  eventName      AnalyticsEventName
  date           DateTime
  count          Int                @default(0)
  uniqueSessions Int?               @default(0)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @default(now()) @updatedAt

  campground   Campground?   @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@unique([campgroundId, eventName, date])
  @@index([organizationId, eventName, date])
}

model AbTest {
  id             String       @id @default(cuid())
  campgroundId   String?
  organizationId String?
  key            String       @unique
  name           String
  description    String?
  status         AbTestStatus @default(draft)
  startedAt      DateTime?
  endedAt        DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt

  campground   Campground?    @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  variants     AbVariant[]
  enrollments  AbEnrollment[]

  @@index([campgroundId, status])
  @@index([organizationId, status])
}

model AbVariant {
  id          String   @id @default(cuid())
  testId      String
  name        String
  description String?
  weight      Int? // optional rollout weight
  createdAt   DateTime @default(now())

  test        AbTest           @relation(fields: [testId], references: [id], onDelete: Cascade)
  events      AnalyticsEvent[]
  enrollments AbEnrollment[]

  @@index([testId])
}

model AbEnrollment {
  id             String   @id @default(cuid())
  testId         String
  variantId      String
  campgroundId   String?
  organizationId String?
  sessionId      String
  enrolledAt     DateTime @default(now())

  test         AbTest        @relation(fields: [testId], references: [id], onDelete: Cascade)
  variant      AbVariant     @relation(fields: [variantId], references: [id], onDelete: Cascade)
  campground   Campground?   @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@unique([testId, sessionId])
  @@index([campgroundId])
  @@index([organizationId])
}

// =============================================================================
// Gamification
// =============================================================================

enum GamificationEventCategory {
  task
  maintenance
  check_in
  reservation_quality
  checklist
  review_mention
  on_time_assignment
  assist
  manual
  other
}

model Organization {
  id   String @id @default(cuid())
  name String

  // Billing & subscription
  subscriptionTier   SubscriptionTier @default(free)
  billingEmail       String?
  billingName        String?
  billingAddress1    String?
  billingAddress2    String?
  billingCity        String?
  billingState       String?
  billingPostalCode  String?
  billingCountry     String?
  stripeCustomerId   String?          @unique
  subscriptionStatus String? // active, past_due, canceled, trialing
  trialEndsAt        DateTime?

  campgrounds              Campground[]
  analyticsEvents          AnalyticsEvent[]
  analyticsDailyAggregates AnalyticsDailyAggregate[]
  abTests                  AbTest[]
  abEnrollments            AbEnrollment[]
  integrationConnections   IntegrationConnection[]

  // Phase 3 relations
  portfolioDashboards   PortfolioDashboard[]
  portfolioMetrics      PortfolioMetric[]
  centralizedRatePushes CentralizedRatePush[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Campground {
  id                String  @id @default(cuid())
  organizationId    String
  name              String
  slug              String  @unique
  isExternal        Boolean @default(false)
  isBookable        Boolean @default(true)
  externalUrl       String?
  nonBookableReason String?

  // Location
  city       String?
  state      String?
  country    String?
  address1   String?
  address2   String?
  postalCode String?
  latitude   Decimal? @db.Decimal(12, 8)
  longitude  Decimal? @db.Decimal(12, 8)
  timezone   String?  @default("UTC")

  // Contact
  phone                String?
  email                String?
  website              String?
  facebookUrl          String?
  instagramUrl         String?
  dataSource           String?
  dataSourceId         String?
  dataSourceUpdatedAt  DateTime?
  dataImportNotes      String?
  provenance           Json?
  gaMeasurementId      String?
  metaPixelId          String?
  aiSuggestionsEnabled Boolean   @default(false)
  aiOpenaiApiKey       String?
  npsAutoSendEnabled   Boolean   @default(false)
  npsSendHour          Int?      @default(7)
  npsTemplateId        String?
  npsSchedule          Json?     @default("[]")

  // Public listing
  description    String?   @db.Text
  tagline        String? // Short marketing tagline
  amenities      String[]  @default([])
  photos         String[]  @default([]) // Array of photo URLs
  photosMeta     Json?
  heroImageUrl   String? // Main hero image for public page
  isPublished    Boolean   @default(false) // Whether visible on public marketplace
  amenitySummary Json?
  importedAt     DateTime?

  // Operations
  seasonStart           DateTime?
  seasonEnd             DateTime?
  checkInTime           String?   @default("15:00")
  checkOutTime          String?   @default("11:00")
  parkTimeZone          String?
  slaMinutes            Int?      @default(30)
  senderDomain          String?
  senderDomainStatus    String? // verified | failed | pending | unknown
  senderDomainCheckedAt DateTime?
  senderDomainDmarc     String?
  senderDomainSpf       String?
  quietHoursStart       String? // HH:mm
  quietHoursEnd         String? // HH:mm
  routingAssigneeId     String?

  // Branding
  logoUrl        String?
  primaryColor   String?
  accentColor    String?
  brandingNote   String?
  secondaryColor String?
  buttonColor    String?
  brandFont      String?
  emailHeader    String?
  receiptFooter  String?

  // Financial
  taxState                    Decimal?       @db.Decimal(10, 4)
  taxLocal                    Decimal?       @db.Decimal(10, 4)
  depositRule                 String? // e.g., none, full, half, first_night, first_night_fees, percentage
  depositPercentage           Int? // For percentage rule (0-100)
  depositConfig               Json?
  defaultDepositPolicyId      String?        @unique
  cancellationPolicyType      String? // flexible, moderate, strict, custom
  cancellationWindowHours     Int? // hours before arrival to allow refund
  cancellationFeeType         String? // flat, percent, first_night
  cancellationFeeFlatCents    Int?
  cancellationFeePercent      Int?
  cancellationNotes           String?        @db.Text
  storeOpenHour               Int? // 0-23
  storeCloseHour              Int? // 0-23
  orderWebhookUrl             String?
  stripeAccountId             String?        @unique
  applicationFeeFlatCents     Int?           @default(300) // Legacy per-booking fee in cents
  billingPlan                 BillingPlan    @default(ota_only)
  perBookingFeeCents          Int?           @default(300) // If null, fall back to plan default
  monthlyFeeCents             Int? // For enterprise plans (e.g., 50000 = $500)
  feeMode                     PaymentFeeMode @default(absorb)
  stripeCapabilities          Json?
  stripeCapabilitiesFetchedAt DateTime?
  reviewScore                 Decimal?       @db.Decimal(4, 2)
  reviewCount                 Int            @default(0)
  reviewSources               Json?
  reviewsUpdatedAt            DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  organization              Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  siteClasses               SiteClass[]
  sites                     Site[]
  reservations              Reservation[]
  maintenance               MaintenanceTicket[]
  pricingRules              PricingRule[]
  pricingRulesV2            PricingRuleV2[]
  demandBands               DemandBand[]               @relation("CampgroundDemandBands")
  depositPolicies           DepositPolicy[]            @relation("CampgroundDepositPolicies")
  payments                  Payment[]
  ledgerEntries             LedgerEntry[]
  memberships               CampgroundMembership[]
  events                    Event[]
  productCategories         ProductCategory[]
  products                  Product[]
  addOnServices             AddOnService[]
  storeOrders               StoreOrder[]
  blackoutDates             BlackoutDate[]
  messages                  Message[]
  communications            Communication[]
  promotions                Promotion[]
  waitlistEntries           WaitlistEntry[]
  taxRules                  TaxRule[]
  seasonalRates             SeasonalRate[]
  defaultDepositPolicy      DepositPolicy?             @relation("CampgroundDefaultDepositPolicy", fields: [defaultDepositPolicyId], references: [id], onDelete: SetNull)
  activities                Activity[]
  membershipTypes           MembershipType[]
  operationalTasks          OperationalTask[]
  internalConversations     InternalConversation[]
  siteHolds                 SiteHold[]
  inviteTokens              InviteToken[]
  auditLogs                 AuditLog[]
  campaigns                 Campaign[]
  campaignTemplates         CampaignTemplate[]
  campaignSends             CampaignSend[]             @relation("CampgroundCampaignSends")
  otaChannels               OtaChannel[]               @relation("CampgroundOtaChannels")
  npsSurveys                NpsSurvey[]
  npsInvites                NpsInvite[]
  npsResponses              NpsResponse[]
  reviewRequests            ReviewRequest[]
  reviews                   Review[]
  reviewVotes               ReviewVote[]
  supportReports            SupportReport[]            @relation("ReportCampground")
  formTemplates             FormTemplate[]
  payouts                   Payout[]
  disputes                  Dispute[]
  analyticsEvents           AnalyticsEvent[]
  analyticsDailyAggregates  AnalyticsDailyAggregate[]
  abTests                   AbTest[]
  abEnrollments             AbEnrollment[]
  socialPosts               SocialPost[]
  socialTemplates           SocialTemplate[]
  socialContentAssets       SocialContentAsset[]
  socialSuggestions         SocialSuggestion[]
  socialWeeklyIdeas         SocialWeeklyIdea[]
  socialStrategies          SocialStrategy[]
  socialOpportunityAlerts   SocialOpportunityAlert[]
  upsellItems               UpsellItem[]
  upsellBundles             UpsellBundle[]
  socialPerformanceInputs   SocialPerformanceInput[]
  gamificationSetting       GamificationSetting?
  xpRules                   XpRule[]
  xpBalances                XpBalance[]
  xpEvents                  XpEvent[]
  pushSubscriptions         PushSubscription[]
  privacySetting            PrivacySetting?
  consentLogs               ConsentLog[]
  approvalRequests          ApprovalRequest[]
  auditExports              AuditExport[]
  approvalPolicies          ApprovalPolicy[]
  permissionRules           PermissionRule[]
  integrationConnections    IntegrationConnection[]
  integrationExportJobs     IntegrationExportJob[]
  apiClients                ApiClient[]
  webhookEndpoints          WebhookEndpoint[]
  communicationTemplates    CommunicationTemplate[]    @relation("CampgroundCommunicationTemplates")
  communicationPlaybooks    CommunicationPlaybook[]    @relation("CampgroundCommunicationPlaybooks")
  communicationPlaybookJobs CommunicationPlaybookJob[] @relation("CampgroundCommunicationPlaybookJobs")
  storedValueAccounts       StoredValueAccount[]
  storedValueLedgers        StoredValueLedger[]
  posTerminals              PosTerminal[]
  posCarts                  PosCart[]
  factReservationsDaily     FactReservationsDaily[]
  factPosDaily              FactPosDaily[]
  factStoredValueDaily      FactStoredValueDaily[]

  // Phase 3 relations
  dynamicPricingRules    DynamicPricingRule[]
  occupancySnapshots     OccupancySnapshot[]
  revenueForecasts       RevenueForecast[]
  communicationWorkflows CommunicationWorkflow[]
  digitalWaivers         DigitalWaiver[]
  waiverTemplates        WaiverTemplate[]
  idVerifications        IdVerification[]
  staffShifts            StaffShift[]
  staffAvailability      StaffAvailability[]
  pushNotifications      PushNotification[]
  staffPerformance       StaffPerformance[]
  savedReports           SavedReport[]
  portfolioMetrics       PortfolioMetric[]
  NotificationTrigger    NotificationTrigger[]
  ScheduledNotification  ScheduledNotification[]

  @@index([dataSource, dataSourceId])
}

model PushSubscription {
  id             String    @id @default(cuid())
  userId         String?
  campgroundId   String?
  endpoint       String    @unique
  keys           Json?
  subscription   Json?
  expirationTime DateTime?
  userAgent      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([campgroundId])
}

model FormTemplate {
  id           String           @id @default(cuid())
  campgroundId String
  title        String
  type         FormTemplateType @default(custom)
  description  String?
  fields       Json?
  isActive     Boolean          @default(true)
  version      Int              @default(1)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now()) @updatedAt

  campground  Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  submissions FormSubmission[]
}

enum FormTemplateType {
  waiver
  vehicle
  intake
  custom
}

model FormSubmission {
  id             String               @id @default(cuid())
  formTemplateId String
  reservationId  String?
  guestId        String?
  status         FormSubmissionStatus @default(pending)
  responses      Json?
  signedAt       DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now()) @updatedAt

  formTemplate FormTemplate @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)
  reservation  Reservation? @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  guest        Guest?       @relation(fields: [guestId], references: [id], onDelete: Cascade)
}

enum FormSubmissionStatus {
  pending
  completed
  void
}

model Campaign {
  id              String         @id @default(cuid())
  campgroundId    String
  name            String
  subject         String
  fromEmail       String
  fromName        String?
  html            String         @db.Text
  textBody        String?        @db.Text
  channel         ChannelType    @default(email)
  templateId      String?
  audienceJson    Json?
  suggestedReason String?
  variables       Json?
  status          CampaignStatus @default(draft)
  scheduledAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @default(now()) @updatedAt

  campground Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  sends      CampaignSend[]
  template   CampaignTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([status])
}

model CampaignSend {
  id                String             @id @default(cuid())
  campaignId        String
  campgroundId      String
  guestId           String?
  email             String
  phone             String?
  channel           ChannelType        @default(email)
  status            CampaignSendStatus @default(queued)
  providerMessageId String?
  error             String?
  sentAt            DateTime?
  createdAt         DateTime           @default(now())

  campaign   Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campground Campground @relation("CampgroundCampaignSends", fields: [campgroundId], references: [id], onDelete: Cascade)
  guest      Guest?     @relation(fields: [guestId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([campgroundId])
  @@index([guestId])
  @@index([status])
}

model CampaignTemplate {
  id           String      @id @default(cuid())
  campgroundId String
  name         String
  channel      ChannelType @default(email)
  category     String?     @default("general")
  subject      String?
  html         String?     @db.Text
  textBody     String?     @db.Text
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @default(now()) @updatedAt

  campground          Campground            @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  campaigns           Campaign[]
  NotificationTrigger NotificationTrigger[]

  @@index([campgroundId])
  @@index([channel])
}

model TaxRule {
  id             String      @id @default(cuid())
  campgroundId   String
  name           String
  type           TaxRuleType
  rate           Decimal?    @db.Decimal(10, 4)
  minNights      Int?
  maxNights      Int?
  requiresWaiver Boolean     @default(false)
  waiverText     String?
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
}

// ---------------------------------------------------------------------------
// Social Media Planner models
// ---------------------------------------------------------------------------

model SocialPost {
  id             String                 @id @default(cuid())
  campgroundId   String
  title          String
  platform       SocialPlatform
  status         SocialPostStatus       @default(draft)
  category       SocialContentCategory?
  scheduledFor   DateTime?
  publishedFor   DateTime?
  caption        String?
  hashtags       String[]               @default([])
  imagePrompt    String?
  notes          String?
  templateId     String?
  assetUrls      String[]               @default([])
  tags           String[]               @default([])
  ideaParkingLot Boolean                @default(false)
  suggestionId   String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  campground        Campground               @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  template          SocialTemplate?          @relation(fields: [templateId], references: [id], onDelete: SetNull)
  suggestion        SocialSuggestion?        @relation("PostSuggestion", fields: [suggestionId], references: [id], onDelete: SetNull)
  performanceInputs SocialPerformanceInput[]

  @@index([campgroundId])
  @@index([platform, status])
  @@index([scheduledFor])
}

model SocialTemplate {
  id             String                 @id @default(cuid())
  campgroundId   String
  name           String
  summary        String?
  category       SocialContentCategory?
  style          SocialTemplateStyle?
  defaultCaption String?
  captionFillIns String?
  imageGuidance  String?
  hashtagSet     String[]               @default([])
  bestTime       String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  campground Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  posts      SocialPost[]

  @@index([campgroundId])
}

model SocialContentAsset {
  id           String          @id @default(cuid())
  campgroundId String
  title        String
  type         SocialAssetType
  url          String
  tags         String[]        @default([])
  notes        String?
  uploadedById String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  uploadedBy User?      @relation("AssetUploader", fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([type])
}

model SocialSuggestion {
  id            String                 @id @default(cuid())
  campgroundId  String
  type          SocialSuggestionType
  status        SocialSuggestionStatus @default(new)
  message       String
  reason        Json?
  category      SocialContentCategory?
  platform      SocialPlatform?
  proposedDate  DateTime?
  opportunityAt DateTime?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  campground Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  posts      SocialPost[] @relation("PostSuggestion")

  @@index([campgroundId])
  @@index([type, status])
  @@index([proposedDate])
}

model SocialWeeklyIdea {
  id           String   @id @default(cuid())
  campgroundId String
  generatedFor DateTime // Monday anchor date
  ideas        Json
  cadence      Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, generatedFor])
  @@index([generatedFor])
}

model SocialStrategy {
  id           String   @id @default(cuid())
  campgroundId String
  month        DateTime
  annual       Boolean  @default(false)
  plan         Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, month])
}

model SocialOpportunityAlert {
  id           String              @id @default(cuid())
  campgroundId String
  category     SocialAlertCategory
  message      String
  startsAt     DateTime?
  endsAt       DateTime?
  dismissed    Boolean             @default(false)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([category])
}

model SocialPerformanceInput {
  id           String   @id @default(cuid())
  campgroundId String
  postId       String?
  likes        Int?
  reach        Int?
  comments     Int?
  saves        Int?
  shares       Int?
  notes        String?
  recordedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  post       SocialPost? @relation(fields: [postId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([postId])
  @@index([recordedAt])
}

model SeasonalRate {
  id           String    @id @default(cuid())
  campgroundId String
  siteClassId  String?
  name         String
  rateType     RateType
  amount       Int
  minNights    Int?
  startDate    DateTime?
  endDate      DateTime?
  isActive     Boolean   @default(true)

  // Payment & Pricing controls
  paymentSchedule   PaymentSchedule  @default(single)
  pricingStructure  PricingStructure @default(per_night)
  offseasonInterval Int? // months between payments (1 or 2)
  offseasonAmount   Int? // amount per offseason payment (cents)
  prorateExcess     Boolean          @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  campground   Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass    SiteClass?    @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  reservations Reservation[]

  @@index([campgroundId])
  @@index([siteClassId])
}

model Site {
  id                String   @id @default(cuid())
  campgroundId      String
  siteClassId       String?
  name              String
  siteNumber        String
  siteType          SiteType
  maxOccupancy      Int
  rigMaxLength      Int?
  hookupsPower      Boolean  @default(false)
  powerAmps         Int?
  hookupsWater      Boolean  @default(false)
  hookupsSewer      Boolean  @default(false)
  petFriendly       Boolean  @default(true)
  accessible        Boolean  @default(false)
  minNights         Int?
  maxNights         Int?
  photos            String[] @default([])
  photoAttributions Json?
  description       String?
  tags              String[] @default([])
  vibeTags          String[] @default([])
  popularityScore   Int      @default(0)
  isActive          Boolean  @default(true)
  status            String? // e.g., available, out_of_service
  latitude          Decimal? @db.Decimal(12, 8)
  longitude         Decimal? @db.Decimal(12, 8)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt

  campground         Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass          SiteClass?          @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  reservations       Reservation[]
  maintenance        MaintenanceTicket[]
  operationalTasks   OperationalTask[]
  housekeepingStatus String              @default("clean") // clean, dirty, inspecting
  blackoutDates      BlackoutDate[]
  holds              SiteHold[]
  otaMappings        OtaListingMapping[] @relation("SiteOtaMappings")
  analyticsEvents    AnalyticsEvent[]
  waitlistEntries    WaitlistEntry[]

  @@unique([campgroundId, name])
  @@index([campgroundId])
  @@index([siteType])
  @@index([siteClassId])
}

model SiteHold {
  id            String    @id @default(cuid())
  campgroundId  String
  siteId        String
  arrivalDate   DateTime
  departureDate DateTime
  expiresAt     DateTime?
  status        String    @default("active") // active, released, expired
  note          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([siteId])
  @@index([expiresAt])
}

model Guest {
  id                String           @id @default(cuid())
  primaryFirstName  String
  primaryLastName   String
  email             String
  emailNormalized   String?
  phone             String?
  phoneNormalized   String?
  preferredContact  String?
  preferredLanguage String?
  address1          String?
  address2          String?
  city              String?
  state             String?
  postalCode        String?
  country           String?
  rigType           String?
  rigLength         Int?
  vehiclePlate      String?
  vehicleState      String?
  tags              String[]         @default([])
  vip               Boolean          @default(false)
  leadSource        String?
  marketingOptIn    Boolean          @default(false)
  repeatStays       Int              @default(0)
  notes             String?
  preferences       Json?
  insights          Json?
  equipment         GuestEquipment[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @default(now()) @updatedAt

  reservations              Reservation[]
  storeOrders               StoreOrder[]
  account                   GuestAccount?
  messages                  Message[]
  communications            Communication[]
  campaignSends             CampaignSend[]
  npsInvites                NpsInvite[]
  npsResponses              NpsResponse[]
  reviewRequests            ReviewRequest[]
  reviews                   Review[]
  reviewVotes               ReviewVote[]
  formSubmissions           FormSubmission[]
  communicationPlaybookJobs CommunicationPlaybookJob[] @relation("GuestCommunicationPlaybookJobs")
  waitlistEntries           WaitlistEntry[]
  storedValueCodes          StoredValueCode[]
  loyaltyProfile            LoyaltyProfile?
  activityBookings          ActivityBooking[]
  memberships               GuestMembership[]

  // Phase 3 relations
  digitalWaivers  DigitalWaiver[]
  idVerifications IdVerification[]

  @@unique([email])
  @@index([emailNormalized])
  @@index([phoneNormalized])
}

model LoyaltyProfile {
  id            String   @id @default(cuid())
  guestId       String   @unique
  pointsBalance Int      @default(0)
  tier          String   @default("Bronze") // Bronze, Silver, Gold, Platinum
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  guest        Guest               @relation(fields: [guestId], references: [id], onDelete: Cascade)
  transactions PointsTransaction[]

  @@index([guestId])
}

model PointsTransaction {
  id        String   @id @default(cuid())
  profileId String
  amount    Int // Positive for earning, negative for spending
  reason    String // e.g., "Reservation #123", "Redemption"
  createdAt DateTime @default(now())

  profile LoyaltyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
}

model GuestAccount {
  id             String    @id @default(cuid())
  guestId        String    @unique
  email          String    @unique
  passwordHash   String?
  magicLinkToken String?   @unique
  tokenExpiry    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([magicLinkToken])
}

model Reservation {
  id                       String            @id @default(cuid())
  campgroundId             String
  siteId                   String
  guestId                  String
  arrivalDate              DateTime
  departureDate            DateTime
  adults                   Int
  children                 Int               @default(0)
  status                   ReservationStatus @default(pending)
  totalAmount              Int               @default(0)
  paidAmount               Int               @default(0)
  balanceAmount            Int               @default(0)
  depositAmount            Int               @default(0)
  depositDueDate           DateTime?
  pricingRuleVersion       String?
  depositPolicyVersion     String?
  nextAutoCollectAttemptAt DateTime?
  paymentStatus            String            @default("unpaid")
  baseSubtotal             Int               @default(0)
  feesAmount               Int               @default(0)
  taxesAmount              Int               @default(0)
  discountsAmount          Int               @default(0)
  promoCode                String?
  source                   String?
  policyVersion            String?
  checkInWindowStart       String?
  checkInWindowEnd         String?
  vehiclePlate             String?
  vehicleState             String?
  rigType                  String?
  rigLength                Int?
  createdBy                String?
  updatedBy                String?
  checkInAt                DateTime?
  checkOutAt               DateTime?
  notes                    String?
  stayType                 StayType          @default(standard)
  taxExempt                Boolean           @default(false)
  taxWaiverSigned          Boolean           @default(false)
  taxWaiverDate            DateTime?
  seasonalRateId           String?

  // Booking metadata
  leadTimeDays     Int? // Days between booking date and arrival date
  bookedAt         DateTime? // Exact timestamp when booking was made
  additionalGuests Json? // Array of { firstName, lastName, email?, phone? }
  childrenDetails  Json? // Array of { name?, gender?, age? }

  groupId                String?
  groupRole              GroupRole?
  checkInStatus          CheckInStatus  @default(not_started)
  checkOutStatus         CheckOutStatus @default(not_started)
  idVerificationRequired Boolean        @default(false)
  waiverRequired         Boolean        @default(false)
  paymentRequired        Boolean        @default(true)
  lateArrivalFlag        Boolean        @default(false)
  siteReady              Boolean        @default(false)
  siteReadyAt            DateTime?
  selfCheckInAt          DateTime?
  selfCheckOutAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  campground     Campground      @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site           Site            @relation(fields: [siteId], references: [id], onDelete: Cascade)
  guest          Guest           @relation(fields: [guestId], references: [id], onDelete: Cascade)
  payments       Payment[]
  ledger         LedgerEntry[]
  storeOrders    StoreOrder[]
  messages       Message[]
  communications Communication[]

  repeatCharges             RepeatCharge[]
  seasonalRate              SeasonalRate?              @relation(fields: [seasonalRateId], references: [id], onDelete: SetNull)
  activityBookings          ActivityBooking[]
  otaImports                OtaReservationImport[]     @relation("ReservationOtaImports")
  formSubmissions           FormSubmission[]
  npsInvites                NpsInvite[]
  npsResponses              NpsResponse[]
  reviewRequests            ReviewRequest[]
  reviews                   Review[]
  payoutLines               PayoutLine[]
  disputes                  Dispute[]
  analyticsEvents           AnalyticsEvent[]
  communicationPlaybookJobs CommunicationPlaybookJob[] @relation("ReservationCommunicationPlaybookJobs")
  upsells                   ReservationUpsell[]

  // Phase 3 relations
  digitalWaivers  DigitalWaiver[]
  idVerifications IdVerification[]

  @@index([campgroundId])
  @@index([siteId])
  @@index([guestId])
  @@index([seasonalRateId])
  @@index([groupId])
}

model MaintenanceTicket {
  id               String              @id @default(cuid())
  campgroundId     String
  siteId           String?
  title            String
  description      String?
  status           MaintenanceStatus   @default(open)
  priority         MaintenancePriority @default(medium)
  dueDate          DateTime?
  assignedTo       String?
  assignedToTeamId String?
  isBlocking       Boolean             @default(false)
  outOfOrder       Boolean             @default(false)
  outOfOrderReason String?
  outOfOrderUntil  DateTime?
  lockId           String?             @unique
  checklist        Json?
  photos           Json?
  notes            String?
  resolvedAt       DateTime?
  reopenedAt       DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site?      @relation(fields: [siteId], references: [id], onDelete: SetNull)
  assignee   User?      @relation(fields: [assignedTo], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([status])
  @@index([dueDate])
  @@index([assignedTo])
}

model PricingRule {
  id            String    @id @default(cuid())
  campgroundId  String
  siteClassId   String?
  label         String?
  ruleType      String // flat, percent, seasonal, dow
  startDate     DateTime?
  endDate       DateTime?
  dayOfWeek     Int?
  percentAdjust Decimal?  @db.Decimal(6, 4)
  flatAdjust    Int?
  minNights     Int?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass  SiteClass? @relation(fields: [siteClassId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([siteClassId])
}

model Payment {
  id                         String    @id @default(cuid())
  campgroundId               String
  reservationId              String
  amountCents                Int
  method                     String    @default("card")
  direction                  String    @default("charge") // charge or refund
  note                       String?
  stripePaymentIntentId      String?
  stripeChargeId             String?
  stripeBalanceTransactionId String?
  stripePayoutId             String?
  applicationFeeCents        Int?
  stripeFeeCents             Int?
  methodType                 String? // card, ach, wallet, etc.
  capturedAt                 DateTime?
  createdAt                  DateTime  @default(now())

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  campground  Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([stripePaymentIntentId])
  @@index([stripeChargeId])
  @@index([stripePayoutId])
}

model RepeatCharge {
  id            String       @id @default(cuid())
  reservationId String
  amount        Int // cents
  dueDate       DateTime
  status        ChargeStatus @default(pending)
  paidAt        DateTime?
  failedAt      DateTime?
  failureReason String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @default(now()) @updatedAt

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([status])
  @@index([dueDate])
}

model LedgerEntry {
  id            String   @id @default(cuid())
  campgroundId  String
  reservationId String?
  glCode        String?
  account       String?
  description   String?
  amountCents   Int
  direction     String   @default("debit")
  occurredAt    DateTime @default(now())
  createdAt     DateTime @default(now())

  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([glCode])
}

enum PayoutStatus {
  pending
  in_transit
  paid
  failed
  canceled
}

model Payout {
  id                  String       @id @default(cuid())
  campgroundId        String
  stripePayoutId      String       @unique
  stripeAccountId     String
  amountCents         Int
  feeCents            Int?
  currency            String       @default("usd")
  status              PayoutStatus @default(pending)
  arrivalDate         DateTime?
  paidAt              DateTime?
  statementDescriptor String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @default(now()) @updatedAt

  lines    PayoutLine[]
  disputes Dispute[]

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([stripeAccountId])
  @@index([status])
}

model PayoutLine {
  id                   String   @id @default(cuid())
  payoutId             String
  type                 String // charge, refund, fee, adjustment, dispute, payout
  amountCents          Int
  currency             String   @default("usd")
  description          String?
  reservationId        String?
  paymentIntentId      String?
  chargeId             String?
  balanceTransactionId String?
  createdAt            DateTime @default(now())

  payout      Payout       @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([payoutId])
  @@index([reservationId])
  @@index([paymentIntentId])
  @@index([chargeId])
  @@index([balanceTransactionId])
}

enum DisputeStatus {
  warning_needs_response
  warning_under_review
  needs_response
  under_review
  charge_refunded
  won
  lost
}

model Dispute {
  id                    String        @id @default(cuid())
  campgroundId          String
  reservationId         String?
  payoutId              String?
  stripeDisputeId       String        @unique
  stripeChargeId        String?
  stripePaymentIntentId String?
  amountCents           Int
  currency              String        @default("usd")
  reason                String?
  status                DisputeStatus @default(needs_response)
  evidenceDueBy         DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @default(now()) @updatedAt
  notes                 String?

  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  payout      Payout?      @relation(fields: [payoutId], references: [id], onDelete: SetNull)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([payoutId])
  @@index([stripeDisputeId])
  @@index([stripeChargeId])
  @@index([stripePaymentIntentId])
  @@index([status])
}

enum EventType {
  activity // Kayaking, hiking tours, etc.
  workshop // Crafts, cooking classes
  entertainment // Live music, movies
  holiday // Special holiday events (parent)
  recurring // Weekly potlucks, etc.
  ongoing // Multi-day continuous (craft station, open swim)
  themed // Themed weekends (Pirate Weekend, Halloween)
}

model Event {
  id           String @id @default(cuid())
  campgroundId String

  // Basic info
  title       String
  description String?   @db.Text
  eventType   EventType @default(activity)

  // Scheduling
  startDate      DateTime
  endDate        DateTime?
  startTime      String? // "14:00"
  endTime        String? // "16:00"
  isAllDay       Boolean   @default(false)
  isRecurring    Boolean   @default(false)
  recurrenceRule String? // iCal RRULE format

  // Location
  location String? // "Main pavilion", "Pool area", etc.

  // Capacity & pricing
  capacity       Int? // Max attendees
  currentSignups Int     @default(0)
  priceCents     Int     @default(0) // 0 = free
  isGuestOnly    Boolean @default(true) // Only campground guests can attend

  // Media
  imageUrl String?

  // Status
  isPublished        Boolean   @default(false)
  isCancelled        Boolean   @default(false)
  cancelledAt        DateTime?
  cancellationReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Recurrence enhancements
  recurrenceEndDate DateTime? // When recurring pattern stops
  recurrenceDays    Int[] // [0]=Sun, [5]=Fri, [6]=Sat

  // Parent event (for holiday/themed grouping)
  parentEventId String?
  parent        Event?  @relation("EventChildren", fields: [parentEventId], references: [id], onDelete: SetNull)
  children      Event[] @relation("EventChildren")

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([startDate])
  @@index([eventType])
  @@index([parentEventId])
}

// =============================================================================
// STORE & ADD-ONS
// =============================================================================

enum AddOnPricingType {
  flat // One-time fee (e.g., late checkout)
  per_night // Per night of stay (e.g., extra vehicle)
  per_person // Per person (e.g., extra guest fee)
}

enum OrderStatus {
  pending
  ready
  delivered
  completed
  cancelled
  refunded
}

enum PaymentMethod {
  card
  cash
  charge_to_site
}

enum OrderChannel {
  pos
  online
  kiosk
  portal
  internal
}

enum FulfillmentType {
  pickup
  curbside
  delivery
  table_service
}

enum ChannelInventoryMode {
  shared
  split
}

model ProductCategory {
  id           String   @id @default(cuid())
  campgroundId String
  name         String
  description  String?
  sortOrder    Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  products   Product[]

  @@unique([campgroundId, name])
  @@index([campgroundId])
}

model Product {
  id                   String               @id @default(cuid())
  campgroundId         String
  categoryId           String?
  name                 String
  description          String?
  priceCents           Int
  imageUrl             String?
  sku                  String?
  stockQty             Int                  @default(0)
  onlineStockQty       Int? // Stock for online/portal channel (when split mode)
  posStockQty          Int? // Stock for POS/kiosk channel (when split mode)
  channelInventoryMode ChannelInventoryMode @default(shared)
  lowStockAlert        Int? // Alert when stock falls below this
  trackInventory       Boolean              @default(true)
  afterHoursAllowed    Boolean              @default(false)
  isActive             Boolean              @default(true)
  sortOrder            Int                  @default(0)
  glCode               String? // For ledger integration
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @default(now()) @updatedAt

  campground Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  category   ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  orderItems StoreOrderItem[]
  posCartItems PosCartItem[]

  @@index([campgroundId])
  @@index([categoryId])
}

model AddOnService {
  id           String           @id @default(cuid())
  campgroundId String
  name         String // "Late Checkout", "Early Check-in", "Extra Vehicle"
  description  String?
  priceCents   Int
  pricingType  AddOnPricingType @default(flat)
  isActive     Boolean          @default(true)
  sortOrder    Int              @default(0)
  glCode       String? // For ledger integration
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now()) @updatedAt

  campground Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  orderItems StoreOrderItem[]

  @@index([campgroundId])
}

model StoreOrder {
  id                   String        @id @default(cuid())
  campgroundId         String
  reservationId        String? // If charged to site
  guestId              String?
  siteNumber           String? // For delivery reference
  channel              OrderChannel  @default(pos)
  fulfillmentType      String? // pickup, delivery, dine_in
  deliveryInstructions String?
  promisedAt           DateTime?
  prepTimeMinutes      Int?
  status               OrderStatus   @default(pending)
  paymentMethod        PaymentMethod @default(card)
  subtotalCents        Int           @default(0)
  taxCents             Int           @default(0)
  totalCents           Int           @default(0)
  notes                String?
  createdBy            String? // Staff user ID
  completedAt          DateTime?
  completedById        String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @default(now()) @updatedAt

  campground  Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation?     @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest?           @relation(fields: [guestId], references: [id], onDelete: SetNull)
  completedBy User?            @relation(fields: [completedById], references: [id], onDelete: SetNull)
  items       StoreOrderItem[]

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
  @@index([status])
}

model StoreOrderItem {
  id         String   @id @default(cuid())
  orderId    String
  productId  String?
  addOnId    String?
  name       String // Snapshot of product/addon name at time of order
  qty        Int      @default(1)
  unitCents  Int
  totalCents Int
  createdAt  DateTime @default(now())

  order   StoreOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product?      @relation(fields: [productId], references: [id], onDelete: SetNull)
  addOn   AddOnService? @relation(fields: [addOnId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@index([addOnId])
}

model BlackoutDate {
  id           String   @id @default(cuid())
  campgroundId String
  siteId       String? // If null, applies to entire campground
  startDate    DateTime
  endDate      DateTime
  reason       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site?      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([siteId])
  @@index([startDate])
  @@index([endDate])
}

enum PromotionType {
  percentage
  flat
}

model Promotion {
  id           String        @id @default(cuid())
  campgroundId String
  code         String // e.g., "SUMMER20"
  type         PromotionType @default(percentage)
  value        Int // Percentage (0-100) or flat cents
  validFrom    DateTime?
  validTo      DateTime?
  usageLimit   Int? // Max total uses
  usageCount   Int           @default(0)
  isActive     Boolean       @default(true)
  description  String? // Internal note
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @default(now()) @updatedAt

  campground      Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  analyticsEvents AnalyticsEvent[]

  @@unique([campgroundId, code])
  @@index([campgroundId])
  @@index([code])
}

model Message {
  id            String     @id @default(cuid())
  campgroundId  String
  reservationId String
  guestId       String
  senderType    SenderType
  content       String     @db.Text
  readAt        DateTime?
  createdAt     DateTime   @default(now())

  campground  Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  guest       Guest       @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
}

enum WaitlistStatus {
  active
  fulfilled
  expired
  cancelled
}

enum WaitlistType {
  regular
  seasonal
}

model WaitlistEntry {
  id             String         @id @default(cuid())
  campgroundId   String
  guestId        String? // Optional - can be null for staff-added entries
  siteId         String? // Specific site preference
  siteTypeId     String? // Or just a type preference (e.g. any RV site)
  arrivalDate    DateTime? // Optional for seasonal (just want "next season")
  departureDate  DateTime? // Optional for seasonal
  status         WaitlistStatus @default(active)
  type           WaitlistType   @default(regular)
  // Contact fields for staff-added entries (when no guest profile exists)
  contactName    String?
  contactEmail   String?
  contactPhone   String?
  notes          String? // Staff notes
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now()) @updatedAt
  lastNotifiedAt DateTime?
  notifiedCount  Int            @default(0)

  // Phase 4: Priority and auto-offer fields
  priority               Int       @default(50) // 0-100, higher = more priority
  autoOffer              Boolean   @default(false) // Auto-reserve when match found
  maxPrice               Int? // Max price willing to pay (cents)
  flexibleDates          Boolean   @default(false) // Accept +/- days from requested
  flexibleDays           Int       @default(0) // How many days flexible
  convertedReservationId String? // If converted to a reservation
  convertedAt            DateTime? // When converted
  throttleBucket         String?
  cooldownUntil          DateTime?
  lastOfferSentAt        DateTime?
  lastOfferStatus        String?
  offerCount             Int       @default(0)

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest      Guest?     @relation(fields: [guestId], references: [id], onDelete: Cascade)
  site       Site?      @relation(fields: [siteId], references: [id], onDelete: SetNull)
  siteClass  SiteClass? @relation(fields: [siteTypeId], references: [id], onDelete: SetNull)
  offers     WaitlistOffer[]
  holds      WaitlistInventoryHold[]

  @@index([campgroundId])
  @@index([guestId])
  @@index([status])
  @@index([type])
  @@index([arrivalDate])
  @@index([priority])
}

enum WaitlistOfferStatus {
  pending
  sent
  accepted
  declined
  expired
  failed
}

model WaitlistOffer {
  id              String             @id @default(cuid())
  entryId         String
  inventoryRef    String
  offerExpiresAt  DateTime
  sentAt          DateTime?
  acceptedAt      DateTime?
  declinedAt      DateTime?
  autoExpiredAt   DateTime?
  status          WaitlistOfferStatus @default(pending)
  commsTemplateId String?
  idempotencyKey  String
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  entry WaitlistEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([entryId, status])
  @@index([idempotencyKey])
  @@index([inventoryRef])
}

model WaitlistInventoryHold {
  id            String   @id @default(cuid())
  inventoryRef  String
  entryId       String?
  status        String   @default("held") // held, released, captured, expired
  holdExpiresAt DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  entry WaitlistEntry? @relation(fields: [entryId], references: [id], onDelete: SetNull)

  @@index([inventoryRef, status])
  @@index([entryId])
}

// ---------------------------------------------------------------------------
// Phase 4: Notification Triggers
// ---------------------------------------------------------------------------

model NotificationTrigger {
  id           String   @id @default(cuid())
  campgroundId String
  event        String // reservation_created, payment_received, checkin_reminder, etc.
  channel      String // email, sms, both
  enabled      Boolean  @default(true)
  templateId   String? // Link to a CampaignTemplate
  delayMinutes Int      @default(0) // 0 = immediate, >0 = scheduled
  conditions   Json? // Conditional rules (e.g. { "source": "online" })
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground             Campground              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  template               CampaignTemplate?       @relation(fields: [templateId], references: [id], onDelete: SetNull)
  scheduledNotifications ScheduledNotification[]

  @@index([campgroundId])
  @@index([event])
  @@index([enabled])
}

model ScheduledNotification {
  id           String    @id @default(cuid())
  campgroundId String
  triggerId    String
  event        String
  channel      String
  payload      Json // TriggerPayload data
  sendAt       DateTime
  status       String    @default("pending") // pending, sent, failed, cancelled
  sentAt       DateTime?
  error        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campground Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  trigger    NotificationTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([status, sendAt])
}

model InternalConversation {
  id           String   @id @default(cuid())
  name         String? // Required for Channels, Null for DMs
  type         String // "channel" or "dm"
  campgroundId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground   Campground                        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  messages     InternalMessage[]
  participants InternalConversationParticipant[]

  @@index([campgroundId])
}

model InternalConversationParticipant {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime @default(now())

  conversation InternalConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model InternalMessage {
  id             String   @id @default(cuid())
  content        String
  senderId       String
  conversationId String
  createdAt      DateTime @default(now())

  sender       User                 @relation(fields: [senderId], references: [id], onDelete: Cascade)
  conversation InternalConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([conversationId])
  @@index([createdAt])
}

model AuditLog {
  id           String    @id @default(cuid())
  campgroundId String
  actorId      String?
  action       String
  entity       String
  entityId     String
  before       Json?
  after        Json?
  ip           String?
  userAgent    String?
  chainHash    String    @default("")
  prevHash     String?
  version      Int       @default(1)
  retentionAt  DateTime?
  createdAt    DateTime  @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  actor      User?      @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([campgroundId, createdAt])
  @@index([campgroundId, chainHash])
}

model AuditExport {
  id            String   @id @default(cuid())
  campgroundId  String
  requestedById String
  format        String // csv | json
  filters       Json?
  recordCount   Int
  createdAt     DateTime @default(now())

  campground  Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  requestedBy User       @relation(fields: [requestedById], references: [id], onDelete: Cascade)

  @@index([campgroundId, createdAt])
  @@index([requestedById, createdAt])
}

model PrivacySetting {
  id                  String   @id @default(cuid())
  campgroundId        String   @unique
  redactPII           Boolean  @default(true)
  consentRequired     Boolean  @default(true)
  backupRetentionDays Int      @default(30)
  keyRotationDays     Int      @default(90)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
}

model ConsentLog {
  id           String        @id @default(cuid())
  campgroundId String
  subject      String
  consentType  String
  grantedBy    String
  method       ConsentMethod @default(digital)
  purpose      String?
  expiresAt    DateTime?
  revokedAt    DateTime?
  metadata     Json?
  grantedAt    DateTime      @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, grantedAt])
}

model PiiFieldTag {
  id             String            @id @default(cuid())
  resource       String
  field          String
  classification PiiClassification
  redactionMode  RedactionMode     @default(mask)
  createdById    String?
  createdAt      DateTime          @default(now())

  createdBy User? @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([resource, field])
  @@index([createdById])
  @@index([classification])
}

model ApprovalPolicy {
  id            String     @id @default(cuid())
  campgroundId  String?
  resource      String
  action        String
  approverRoles UserRole[]
  rationale     String?
  createdById   String?
  createdAt     DateTime   @default(now())

  campground Campground?       @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  createdBy  User?             @relation(fields: [createdById], references: [id], onDelete: SetNull)
  requests   ApprovalRequest[] @relation("ApprovalPolicy_campground_action")

  @@unique([campgroundId, action])
  @@index([campgroundId, action])
}

model ApprovalRequest {
  id            String         @id @default(cuid())
  campgroundId  String?
  action        String
  requestedBy   String
  resource      String?
  targetId      String?
  payload       Json?
  justification String?
  status        ApprovalStatus @default(pending)
  decidedBy     String?
  decidedAt     DateTime?
  createdAt     DateTime       @default(now())

  campground Campground?     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  policy     ApprovalPolicy? @relation("ApprovalPolicy_campground_action", fields: [campgroundId, action], references: [campgroundId, action], onDelete: SetNull, onUpdate: Cascade, map: "ApprovalPolicy_campground_action")

  @@index([campgroundId, status])
}

model PermissionRule {
  id           String           @id @default(cuid())
  campgroundId String?
  role         UserRole
  resource     String
  action       String
  fields       String[]
  effect       PermissionEffect @default(allow)
  createdById  String?
  createdAt    DateTime         @default(now())

  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  createdBy  User?       @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([campgroundId, role, resource, action])
  @@index([resource, action])
}

model InviteToken {
  id           String    @id @default(cuid())
  token        String    @unique
  userId       String
  campgroundId String
  expiresAt    DateTime
  redeemedAt   DateTime?
  createdAt    DateTime  @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([userId, campgroundId])
  @@index([campgroundId, createdAt])
}

model Activity {
  id           String   @id @default(cuid())
  campgroundId String
  name         String
  description  String?
  images       String[] @default([])
  price        Int // in cents
  duration     Int // in minutes
  capacity     Int // max participants per session
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  sessions   ActivitySession[]
}

model ActivitySession {
  id          String   @id @default(cuid())
  activityId  String
  startTime   DateTime
  endTime     DateTime
  capacity    Int // Override activity capacity if needed
  bookedCount Int      @default(0)
  status      String   @default("scheduled") // scheduled, cancelled, completed

  activity Activity          @relation(fields: [activityId], references: [id], onDelete: Cascade)
  bookings ActivityBooking[]
}

model ActivityBooking {
  id            String   @id @default(cuid())
  sessionId     String
  guestId       String
  reservationId String? // Optional link to a stay
  quantity      Int
  totalAmount   Int
  status        String   @default("confirmed") // confirmed, cancelled
  createdAt     DateTime @default(now())

  session     ActivitySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  guest       Guest           @relation(fields: [guestId], references: [id], onDelete: Cascade)
  reservation Reservation?    @relation(fields: [reservationId], references: [id])
}

model MembershipType {
  id              String  @id @default(cuid())
  campgroundId    String
  name            String
  description     String?
  price           Int // in cents
  durationDays    Int // 365 for annual
  discountPercent Int // e.g., 10 for 10% off
  isActive        Boolean @default(true)

  campground  Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  memberships GuestMembership[]
}

model GuestMembership {
  id               String   @id @default(cuid())
  membershipTypeId String
  guestId          String
  startDate        DateTime
  endDate          DateTime
  status           String   @default("active") // active, expired, cancelled
  purchaseAmount   Int

  membershipType MembershipType @relation(fields: [membershipTypeId], references: [id])
  guest          Guest          @relation(fields: [guestId], references: [id], onDelete: Cascade)
}

model OperationalTask {
  id           String    @id @default(cuid())
  campgroundId String
  title        String
  description  String?
  type         String // housekeeping, maintenance, inspection
  status       String    @default("pending") // pending, in_progress, completed, verified
  priority     String    @default("medium") // low, medium, high, urgent
  assignedTo   String? // User ID
  dueDate      DateTime?
  completedAt  DateTime?

  // Relations
  siteId     String?
  site       Site?      @relation(fields: [siteId], references: [id])
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Communication {
  id                String    @id @default(cuid())
  campgroundId      String
  organizationId    String?
  guestId           String?
  reservationId     String?
  type              String // email | sms | note | call
  direction         String // inbound | outbound
  subject           String?
  body              String?
  preview           String?
  status            String // sent | delivered | failed | queued | received
  provider          String?
  providerMessageId String?
  toAddress         String?
  fromAddress       String?
  sentAt            DateTime?
  receivedAt        DateTime?
  metadata          Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt

  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, createdAt])
  @@index([guestId, createdAt])
  @@index([reservationId, createdAt])
  @@index([type, direction])
}

model CommunicationTemplate {
  id           String    @id @default(cuid())
  campgroundId String
  name         String
  subject      String?
  bodyHtml     String?
  status       String    @default("draft") // draft | pending | approved | rejected
  version      Int       @default(1)
  approvedById String?
  approvedAt   DateTime?
  auditLog     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campground Campground              @relation("CampgroundCommunicationTemplates", fields: [campgroundId], references: [id], onDelete: Cascade)
  approvedBy User?                   @relation("CommunicationTemplateApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  playbooks  CommunicationPlaybook[] @relation("PlaybookTemplate")

  @@index([campgroundId])
  @@index([status])
}

model CommunicationPlaybook {
  id                String   @id @default(cuid())
  campgroundId      String
  type              String // arrival | unpaid | upsell | abandoned_cart
  enabled           Boolean  @default(false)
  templateId        String?
  channel           String? // email | sms
  offsetMinutes     Int? // relative to event (e.g., -120 for arrival-2h)
  quietHoursStart   String? // HH:mm
  quietHoursEnd     String? // HH:mm
  throttlePerMinute Int?
  routingAssigneeId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  campground Campground                 @relation("CampgroundCommunicationPlaybooks", fields: [campgroundId], references: [id], onDelete: Cascade)
  template   CommunicationTemplate?     @relation("PlaybookTemplate", fields: [templateId], references: [id], onDelete: SetNull)
  jobs       CommunicationPlaybookJob[] @relation("PlaybookJobs")

  @@index([campgroundId, type])
  @@index([templateId])
}

model CommunicationPlaybookJob {
  id            String   @id @default(cuid())
  playbookId    String
  campgroundId  String
  reservationId String?
  guestId       String?
  status        String   @default("pending") // pending | processing | sent | failed | skipped
  scheduledAt   DateTime
  attempts      Int      @default(0)
  lastError     String?
  metadata      Json?    @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  playbook    CommunicationPlaybook @relation("PlaybookJobs", fields: [playbookId], references: [id], onDelete: Cascade)
  campground  Campground            @relation("CampgroundCommunicationPlaybookJobs", fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation?          @relation("ReservationCommunicationPlaybookJobs", fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest?                @relation("GuestCommunicationPlaybookJobs", fields: [guestId], references: [id], onDelete: SetNull)

  @@index([playbookId, status, scheduledAt])
  @@index([campgroundId])
  @@index([reservationId])
}

model OtaChannel {
  id                         String    @id @default(cuid())
  campgroundId               String
  name                       String
  provider                   String
  status                     String    @default("disabled") // disabled | pull | two_way
  rateMultiplier             Float     @default(1.0)
  defaultStatus              String    @default("confirmed") // confirmed | pending
  sendEmailNotifications     Boolean   @default(false)
  ignoreSiteRestrictions     Boolean   @default(false)
  ignoreCategoryRestrictions Boolean   @default(false)
  feeMode                    String    @default("absorb") // absorb | pass_through
  webhookSecret              String?
  lastSyncAt                 DateTime?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt

  campground Campground             @relation("CampgroundOtaChannels", fields: [campgroundId], references: [id], onDelete: Cascade)
  mappings   OtaListingMapping[]
  syncLogs   OtaSyncLog[]
  imports    OtaReservationImport[]

  @@index([campgroundId])
  @@index([provider, campgroundId])
}

model OtaListingMapping {
  id          String    @id @default(cuid())
  channelId   String
  siteId      String?
  siteClassId String?
  externalId  String
  status      String    @default("mapped") // mapped | disabled
  lastSyncAt  DateTime?
  lastError   String?
  icalToken   String?   @unique
  icalUrl     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  channel   OtaChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  site      Site?      @relation("SiteOtaMappings", fields: [siteId], references: [id], onDelete: SetNull)
  siteClass SiteClass? @relation("SiteClassOtaMappings", fields: [siteClassId], references: [id], onDelete: SetNull)

  @@unique([channelId, externalId], name: "channelId_externalId")
  @@index([channelId, siteId])
  @@index([channelId, siteClassId])
}

model OtaSyncLog {
  id        String   @id @default(cuid())
  channelId String
  direction String // push | pull
  eventType String // availability | pricing | reservation
  status    String // success | failed
  message   String?
  payload   Json?
  createdAt DateTime @default(now())

  channel OtaChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId, createdAt])
  @@index([channelId, direction, eventType])
}

model OtaReservationImport {
  id                    String   @id @default(cuid())
  channelId             String
  externalReservationId String
  status                String // pending | imported | failed
  message               String?
  reservationId         String?
  createdAt             DateTime @default(now())

  channel     OtaChannel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation("ReservationOtaImports", fields: [reservationId], references: [id], onDelete: SetNull)

  @@unique([channelId, externalReservationId])
  @@index([reservationId])
}

// =============================================================================
// NPS
// =============================================================================

model NpsSurvey {
  id              String          @id @default(cuid())
  campgroundId    String
  name            String
  question        String?
  status          NpsSurveyStatus @default(draft)
  channels        String[]        @default(["inapp", "email"])
  locales         String[]        @default(["en"])
  cooldownDays    Int? // minimum days between invites per guest
  samplingPercent Int? // 0-100
  metadata        Json?
  activeFrom      DateTime?
  activeTo        DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @default(now()) @updatedAt

  campground Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  rules      NpsRule[]
  invites    NpsInvite[]
  responses  NpsResponse[]

  @@index([campgroundId, status])
}

model NpsRule {
  id           String   @id @default(cuid())
  surveyId     String
  trigger      String // post_checkout | post_booking | manual
  percentage   Int? // sampling percent override
  cooldownDays Int? // override per rule
  segmentJson  Json?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  survey NpsSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId, isActive])
}

model NpsInvite {
  id             String          @id @default(cuid())
  surveyId       String
  campgroundId   String
  organizationId String?
  guestId        String?
  reservationId  String?
  channel        String // email | sms | inapp
  status         NpsInviteStatus @default(queued)
  token          String          @unique
  expiresAt      DateTime?
  sentAt         DateTime?
  openedAt       DateTime?
  respondedAt    DateTime?
  metadata       Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @default(now()) @updatedAt

  survey      NpsSurvey    @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  response    NpsResponse?
  events      NpsEvent[]

  @@index([campgroundId, status])
  @@index([guestId])
  @@index([reservationId])
}

model NpsResponse {
  id            String   @id @default(cuid())
  surveyId      String
  inviteId      String?
  campgroundId  String
  guestId       String?
  reservationId String?
  score         Int
  comment       String?
  tags          String[] @default([])
  sentiment     String?
  createdAt     DateTime @default(now())

  survey      NpsSurvey    @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  invite      NpsInvite?   @relation(fields: [inviteId], references: [id], onDelete: SetNull)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@unique([inviteId])
  @@index([campgroundId, createdAt])
  @@index([surveyId])
  @@index([guestId])
  @@index([reservationId])
}

model NpsEvent {
  id        String   @id @default(cuid())
  inviteId  String
  type      String // open | click | unsub
  payload   Json?
  createdAt DateTime @default(now())

  invite NpsInvite @relation(fields: [inviteId], references: [id], onDelete: Cascade)

  @@index([inviteId, type])
}

// =============================================================================
// Reviews
// =============================================================================

model ReviewRequest {
  id             String    @id @default(cuid())
  campgroundId   String
  organizationId String?
  guestId        String?
  reservationId  String?
  channel        String // email | sms | inapp | kiosk
  status         String    @default("queued")
  token          String    @unique
  expiresAt      DateTime?
  sentAt         DateTime?
  respondedAt    DateTime?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  review      Review?

  @@index([campgroundId, status])
  @@index([guestId])
  @@index([reservationId])
}

model Review {
  id             String         @id @default(cuid())
  campgroundId   String
  organizationId String?
  guestId        String?
  reservationId  String?
  requestId      String?
  rating         Int
  title          String?
  body           String?        @db.Text
  photos         String[]       @default([])
  tags           String[]       @default([])
  sentiment      String?
  source         ReviewSource   @default(onsite)
  status         ReviewStatus   @default(pending)
  exposure       ReviewExposure @default(private)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now()) @updatedAt

  campground  Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?            @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation?      @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  request     ReviewRequest?    @relation(fields: [requestId], references: [id], onDelete: SetNull)
  moderation  ReviewModeration?
  votes       ReviewVote[]
  replies     ReviewReply[]

  @@unique([requestId])
  @@index([campgroundId, status, createdAt])
  @@index([guestId])
  @@index([reservationId])
  @@index([source])
}

model ReviewModeration {
  id        String                 @id @default(cuid())
  reviewId  String                 @unique
  status    ReviewModerationStatus @default(pending)
  reasons   String[]               @default([])
  decidedBy String?
  decidedAt DateTime?
  notes     String?

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
}

model ReviewVote {
  id           String          @id @default(cuid())
  reviewId     String
  guestId      String?
  ipHash       String?
  value        ReviewVoteValue
  createdAt    DateTime        @default(now())
  campgroundId String

  review     Review     @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  guest      Guest?     @relation(fields: [guestId], references: [id], onDelete: SetNull)
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([reviewId, guestId])
  @@index([reviewId])
  @@index([ipHash])
  @@index([campgroundId])
}

model ReviewReply {
  id         String   @id @default(cuid())
  reviewId   String
  authorType String // staff | guest
  authorId   String?
  body       String   @db.Text
  createdAt  DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
}

// =============================================================================
// GAMIFICATION
// =============================================================================

model GamificationSetting {
  id           String     @id @default(cuid())
  campgroundId String     @unique
  enabled      Boolean    @default(false)
  enabledRoles UserRole[] @default([])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
}

model LevelDefinition {
  id        String   @id @default(cuid())
  level     Int      @unique
  name      String
  minXp     Int
  perks     Json?
  createdAt DateTime @default(now())
}

model XpRule {
  id           String                    @id @default(cuid())
  campgroundId String
  category     GamificationEventCategory
  minXp        Int                       @default(0)
  maxXp        Int                       @default(0)
  defaultXp    Int                       @default(0)
  isActive     Boolean                   @default(true)
  createdById  String?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  createdBy  User?      @relation("XpRuleCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([campgroundId, category])
  @@index([campgroundId])
  @@index([createdById])
}

model XpBalance {
  id           String    @id @default(cuid())
  campgroundId String
  userId       String
  totalXp      Int       @default(0)
  currentLevel Int       @default(1)
  lastEventAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, userId])
  @@index([campgroundId])
  @@index([userId])
}

model XpEvent {
  id           String                    @id @default(cuid())
  campgroundId String
  userId       String
  membershipId String?
  category     GamificationEventCategory
  xp           Int
  reason       String?
  sourceType   String?
  sourceId     String?
  eventKey     String?                   @unique
  metadata     Json?
  occurredAt   DateTime                  @default(now())
  createdAt    DateTime                  @default(now())

  campground Campground            @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  membership CampgroundMembership? @relation(fields: [membershipId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([userId])
  @@index([campgroundId, userId])
  @@index([membershipId])
  @@index([category])
}

// =============================================================================
// Integrations & Ecosystem
// =============================================================================

model IntegrationConnection {
  id             String    @id @default(cuid())
  campgroundId   String?
  organizationId String?
  type           String // accounting | access_control | crm | export
  provider       String // qbo | xero | hubspot | intercom | zendesk | sftp | api
  status         String    @default("disconnected") // disconnected | connected | error | pending
  authType       String? // oauth | api_key | basic | sftp
  credentials    Json?
  settings       Json?
  webhookSecret  String?
  lastSyncAt     DateTime?
  lastSyncStatus String?
  lastError      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  campground   Campground?               @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  organization Organization?             @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  logs         IntegrationSyncLog[]
  webhooks     IntegrationWebhookEvent[]
  exportJobs   IntegrationExportJob[]

  @@unique([campgroundId, type, provider])
  @@index([campgroundId, type, provider])
}

model IntegrationSyncLog {
  id           String   @id @default(cuid())
  connectionId String
  direction    String // pull | push | webhook | export
  scope        String // accounting | access_control | crm | export
  status       String // success | failed | queued
  message      String?
  payload      Json?
  occurredAt   DateTime @default(now())
  createdAt    DateTime @default(now())

  connection IntegrationConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId, occurredAt])
  @@index([status])
}

model IntegrationWebhookEvent {
  id             String   @id @default(cuid())
  connectionId   String?
  provider       String
  eventType      String?
  status         String   @default("received") // received | ignored | failed
  signatureValid Boolean?
  message        String?
  payload        Json?
  receivedAt     DateTime @default(now())

  connection IntegrationConnection? @relation(fields: [connectionId], references: [id], onDelete: SetNull)

  @@index([provider, receivedAt])
  @@index([connectionId, receivedAt])
}

model IntegrationExportJob {
  id            String    @id @default(cuid())
  connectionId  String?
  campgroundId  String?
  type          String // api | sftp
  resource      String? // ledger | reservations | guests | activities
  status        String    @default("queued") // queued | processing | success | failed
  location      String?
  requestedById String?
  filters       Json?
  startedAt     DateTime?
  completedAt   DateTime?
  lastError     String?
  createdAt     DateTime  @default(now())

  connection  IntegrationConnection? @relation(fields: [connectionId], references: [id], onDelete: SetNull)
  campground  Campground?            @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  requestedBy User?                  @relation(fields: [requestedById], references: [id], onDelete: SetNull)

  @@index([campgroundId, status])
  @@index([connectionId, status])
  @@index([requestedById])
}

// =============================================================================
// Developer Ecosystem: Public API + Webhooks
// =============================================================================

model ApiClient {
  id               String   @id @default(cuid())
  campgroundId     String
  name             String
  clientId         String   @unique
  clientSecretHash String
  scopes           String[]
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  campground       Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  tokens           ApiToken[]
  webhookEndpoints WebhookEndpoint[]

  @@index([campgroundId])
}

model ApiToken {
  id               String    @id @default(cuid())
  apiClientId      String
  accessTokenHash  String    @unique
  refreshTokenHash String?
  scopes           String[]
  expiresAt        DateTime
  revokedAt        DateTime?
  createdAt        DateTime  @default(now())

  apiClient ApiClient @relation(fields: [apiClientId], references: [id], onDelete: Cascade)

  @@index([apiClientId])
  @@index([expiresAt])
}

model WebhookEndpoint {
  id           String    @id @default(cuid())
  campgroundId String
  apiClientId  String?
  url          String
  secret       String
  eventTypes   String[] // e.g., reservation.created, payment.created, event.updated
  description  String?
  isActive     Boolean   @default(true)
  disabledAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campground Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  apiClient  ApiClient?        @relation(fields: [apiClientId], references: [id], onDelete: SetNull)
  deliveries WebhookDelivery[]

  @@index([campgroundId, isActive])
  @@index([apiClientId])
}

model WebhookDelivery {
  id                String    @id @default(cuid())
  webhookEndpointId String
  eventType         String
  status            String // pending | delivered | failed
  payload           Json
  responseStatus    Int?
  responseBody      String?
  attempt           Int       @default(1)
  signature         String?
  createdAt         DateTime  @default(now())
  deliveredAt       DateTime?
  errorMessage      String?
  replayOfId        String?

  webhookEndpoint WebhookEndpoint @relation(fields: [webhookEndpointId], references: [id], onDelete: Cascade)

  @@index([webhookEndpointId, createdAt])
  @@index([eventType])
  @@index([status])
}

// =============================================================================
// Phase 1: Dynamic pricing, deposits, upsells, idempotency, audit
// =============================================================================

enum PricingRuleType {
  season
  weekend
  holiday
  event
  demand
}

enum PricingStackMode {
  additive
  max
  override
}

enum AdjustmentType {
  percent
  flat
}

enum DepositStrategy {
  first_night
  percent
  fixed
}

enum DepositApplyTo {
  lodging_only
  lodging_plus_fees
}

enum DepositDueTiming {
  at_booking
  before_arrival
}

enum BackoffStrategy {
  fixed
  linear
  exponential
}

enum UpsellPriceType {
  flat
  per_night
  per_guest
  per_site
}

enum UpsellChargeType {
  pay_now
  add_to_reservation
}

enum UpsellStatus {
  pending_charge
  charged
  canceled
}

enum IdempotencyStatus {
  pending
  inflight
  succeeded
  failed
}

model PricingRuleV2 {
  id              String           @id @default(cuid())
  campgroundId    String
  siteClassId     String?
  name            String
  type            PricingRuleType
  priority        Int
  stackMode       PricingStackMode
  adjustmentType  AdjustmentType
  adjustmentValue Decimal          @db.Decimal(8, 4)
  startDate       DateTime?
  endDate         DateTime?
  dowMask         Int[]
  calendarRefId   String?
  demandBandId    String?
  minRateCap      Int?
  maxRateCap      Int?
  active          Boolean          @default(true)
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass  SiteClass? @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
}

model DemandBand {
  id              String         @id @default(cuid())
  campgroundId    String
  siteClassId     String?
  thresholdPct    Int // 0-100 occupancy threshold
  adjustmentType  AdjustmentType
  adjustmentValue Decimal        @db.Decimal(8, 4)
  priority        Int
  active          Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  campground Campground @relation("CampgroundDemandBands", fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass  SiteClass? @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
}

model DepositPolicy {
  id           String               @id @default(cuid())
  campgroundId String
  siteClassId  String?
  name         String
  strategy     DepositStrategy
  value        Int
  minCap       Int?
  maxCap       Int?
  applyTo      DepositApplyTo
  dueTiming    DepositDueTiming
  retryPlanId  String?
  active       Boolean              @default(true)
  version      Int                  @default(1)
  createdBy    String?
  updatedBy    String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  schedule     AutoCollectSchedule?

  campground           Campground  @relation("CampgroundDepositPolicies", fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass            SiteClass?  @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  defaultForCampground Campground? @relation("CampgroundDefaultDepositPolicy")
}

model AutoCollectSchedule {
  id                       String          @id @default(cuid())
  depositPolicyId          String          @unique
  attemptOffsetsDays       Int[]
  cutoffHoursBeforeArrival Int
  backoffStrategy          BackoffStrategy
  maxAttempts              Int
  notifyTemplateIds        Json?
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt

  policy DepositPolicy @relation(fields: [depositPolicyId], references: [id], onDelete: Cascade)
}

model UpsellItem {
  id                String             @id @default(cuid())
  campgroundId      String
  siteClassId       String?
  name              String
  description       String?
  priceType         UpsellPriceType
  priceCents        Int
  taxCode           String?
  inventoryTracking Boolean            @default(false)
  active            Boolean            @default(true)
  version           Int                @default(1)
  createdBy         String?
  updatedBy         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  bundles           UpsellBundleItem[]

  campground         Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass          SiteClass?          @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  reservationUpsells ReservationUpsell[]
}

model UpsellBundle {
  id           String             @id @default(cuid())
  campgroundId String
  name         String
  priceMode    String // "bundle" or "sum"
  bundlePrice  Int?
  active       Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  items        UpsellBundleItem[]

  campground         Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservationUpsells ReservationUpsell[]
}

model UpsellBundleItem {
  id       String       @id @default(cuid())
  bundleId String
  itemId   String
  required Boolean      @default(true)
  quantity Int          @default(1)
  bundle   UpsellBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  item     UpsellItem   @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

model ReservationUpsell {
  id              String           @id @default(cuid())
  reservationId   String
  itemId          String?
  bundleId        String?
  quantity        Int              @default(1)
  priceSnapshot   Json
  taxCodeSnapshot String?
  chargeType      UpsellChargeType
  status          UpsellStatus     @default(pending_charge)
  attemptNo       Int              @default(0)
  idempotencyKey  String?
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  reservation Reservation   @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  item        UpsellItem?   @relation(fields: [itemId], references: [id], onDelete: SetNull)
  bundle      UpsellBundle? @relation(fields: [bundleId], references: [id], onDelete: SetNull)
}

model IdempotencyKey {
  id           String            @id @default(cuid())
  campgroundId String?
  key          String            @unique
  requestHash  String
  responseJson Json?
  status       IdempotencyStatus @default(pending)
  resourceRef  String?
  lastSeenAt   DateTime          @default(now())
  createdAt    DateTime          @default(now())
}

// Phase 2: housekeeping/maintenance/groups/blocks
model Task {
  id               String    @id @default(cuid())
  tenantId         String
  type             TaskType
  state            TaskState
  priority         String?
  siteId           String
  reservationId    String?
  assignedToUserId String?
  assignedToTeamId String?
  slaDueAt         DateTime?
  slaStatus        SlaStatus @default(on_track)
  checklist        Json?
  photos           Json?
  notes            String?
  source           String?
  createdBy        String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([tenantId, siteId, state])
  @@index([tenantId, slaStatus])
}

// Inventory blocks and groups
model InventoryBlock {
  blockId     String   @id @default(cuid())
  tenantId    String
  sites       Json
  windowStart DateTime
  windowEnd   DateTime
  reason      String
  state       String
  lockId      String   @unique
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
}

model Group {
  id                   String   @id @default(cuid())
  tenantId             String
  sharedPayment        Boolean  @default(false)
  sharedComm           Boolean  @default(false)
  primaryReservationId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

// ============================================================
// PHASE 3: Revenue, Channels, Comms, Staff, Analytics, Portfolio
// ============================================================

// --- Phase 3A: Revenue & Channel Management ---

enum DynamicPricingTrigger {
  occupancy_high
  occupancy_low
  demand_surge
  last_minute
  advance_booking
  event_proximity
  weather
  manual
}

model DynamicPricingRule {
  id              String                @id @default(cuid())
  campgroundId    String
  name            String
  trigger         DynamicPricingTrigger
  conditions      Json // { occupancyMin, occupancyMax, daysOut, etc }
  adjustmentType  String // percent | flat
  adjustmentValue Float
  priority        Int                   @default(100)
  siteClassIds    String[] // empty = all classes
  isActive        Boolean               @default(true)
  validFrom       DateTime?
  validTo         DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, isActive])
}

model OccupancySnapshot {
  id           String     @id @default(cuid())
  campgroundId String
  date         DateTime   @db.Date
  totalSites   Int
  occupied     Int
  blocked      Int
  available    Int
  occupancyPct Float
  revenueCents Int        @default(0)
  createdAt    DateTime   @default(now())
  Campground   Campground @relation(fields: [campgroundId], references: [id])

  @@unique([campgroundId, date])
  @@index([campgroundId, date])
}

model RevenueForecast {
  id           String     @id @default(cuid())
  campgroundId String
  forecastDate DateTime   @db.Date
  projectedRev Int // cents
  actualRev    Int? // cents, filled in after the fact
  occupancyPct Float
  confidence   Float? // 0-1
  factors      Json? // what drove the forecast
  createdAt    DateTime   @default(now())
  Campground   Campground @relation(fields: [campgroundId], references: [id])

  @@unique([campgroundId, forecastDate])
  @@index([campgroundId, forecastDate])
}

// --- Phase 3B: Communications & Guest Experience ---

enum WorkflowTrigger {
  reservation_created
  reservation_confirmed
  days_before_arrival
  check_in
  days_after_checkin
  check_out
  days_after_checkout
  payment_received
  payment_failed
  review_received
  birthday
  anniversary
  manual
}

enum WorkflowStatus {
  active
  paused
  draft
  archived
}

model CommunicationWorkflow {
  id           String          @id @default(cuid())
  campgroundId String
  name         String
  description  String?
  trigger      WorkflowTrigger
  triggerValue Int? // e.g., days before/after
  conditions   Json? // additional filters
  status       WorkflowStatus  @default(draft)
  priority     Int             @default(100)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  campground Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  steps      WorkflowStep[]
  executions WorkflowExecution[]

  @@index([campgroundId, status])
}

model WorkflowStep {
  id         String  @id @default(cuid())
  workflowId String
  stepOrder  Int
  actionType String // send_email | send_sms | wait | condition | webhook
  config     Json // template, delay, conditions, etc.
  isActive   Boolean @default(true)

  workflow CommunicationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, stepOrder])
}

enum WorkflowExecutionStatus {
  pending
  running
  completed
  failed
  cancelled
}

model WorkflowExecution {
  id            String                  @id @default(cuid())
  workflowId    String
  reservationId String?
  guestId       String?
  status        WorkflowExecutionStatus @default(pending)
  currentStep   Int                     @default(0)
  context       Json? // runtime data
  startedAt     DateTime?
  completedAt   DateTime?
  error         String?
  createdAt     DateTime                @default(now())

  workflow CommunicationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, status])
  @@index([reservationId])
}

enum WaiverStatus {
  pending
  signed
  expired
  declined
}

model DigitalWaiver {
  id            String       @id @default(cuid())
  campgroundId  String
  reservationId String?
  guestId       String
  templateId    String?
  status        WaiverStatus @default(pending)
  signedAt      DateTime?
  signatureData Json? // base64 signature image
  ipAddress     String?
  userAgent     String?
  pdfUrl        String?
  expiresAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest        @relation(fields: [guestId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([campgroundId, status])
  @@index([reservationId])
  @@index([guestId])
}

model WaiverTemplate {
  id           String   @id @default(cuid())
  campgroundId String
  name         String
  content      String   @db.Text
  version      Int      @default(1)
  isDefault    Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
}

enum IdVerificationStatus {
  pending
  verified
  failed
  expired
}

model IdVerification {
  id            String               @id @default(cuid())
  campgroundId  String
  guestId       String
  reservationId String?
  status        IdVerificationStatus @default(pending)
  provider      String? // e.g., stripe_identity, jumio
  providerRef   String?
  verifiedAt    DateTime?
  expiresAt     DateTime?
  documentType  String? // passport, drivers_license, etc
  metadata      Json?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest        @relation(fields: [guestId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([guestId])
  @@index([reservationId])
}

// --- Phase 3C: Staff Operations ---

model StaffShift {
  id           String    @id @default(cuid())
  campgroundId String
  userId       String
  shiftDate    DateTime  @db.Date
  startTime    DateTime
  endTime      DateTime
  role         String? // front_desk, housekeeping, maintenance, etc
  notes        String?
  clockedInAt  DateTime?
  clockedOutAt DateTime?
  createdBy    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("StaffShifts", fields: [userId], references: [id], onDelete: Cascade)

  @@index([campgroundId, shiftDate])
  @@index([userId, shiftDate])
}

model StaffAvailability {
  id           String   @id @default(cuid())
  campgroundId String
  userId       String
  dayOfWeek    Int // 0=Sunday, 6=Saturday
  startTime    String // HH:mm
  endTime      String // HH:mm
  isAvailable  Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("StaffAvailability", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, userId, dayOfWeek])
}

enum PushNotificationType {
  arrival
  departure
  task_assigned
  task_sla_warning
  maintenance_urgent
  payment_received
  payment_failed
  message_received
  general
}

model PushNotification {
  id           String               @id @default(cuid())
  campgroundId String
  userId       String?
  type         PushNotificationType
  title        String
  body         String
  data         Json?
  sentAt       DateTime?
  readAt       DateTime?
  clickedAt    DateTime?
  createdAt    DateTime             @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User?      @relation("PushNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([campgroundId, userId, createdAt])
}

model StaffPerformance {
  id              String   @id @default(cuid())
  campgroundId    String
  userId          String
  periodStart     DateTime @db.Date
  periodEnd       DateTime @db.Date
  tasksCompleted  Int      @default(0)
  tasksSlaOnTime  Int      @default(0)
  checkinsHandled Int      @default(0)
  avgTaskMinutes  Float?
  hoursWorked     Float?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("StaffPerformance", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, userId, periodStart, periodEnd])
  @@index([campgroundId, periodStart])
}

// --- Phase 3D: Analytics & Reporting ---

enum ReportScheduleFrequency {
  daily
  weekly
  monthly
  quarterly
}

model SavedReport {
  id           String                   @id @default(cuid())
  campgroundId String?
  orgId        String?
  createdById  String
  name         String
  description  String?
  reportType   String // revenue, occupancy, guests, custom
  config       Json // columns, filters, grouping
  isPublic     Boolean                  @default(false)
  scheduleFreq ReportScheduleFrequency?
  scheduleDay  Int? // day of week/month
  scheduleTime String? // HH:mm
  recipients   String[] // email addresses
  lastRunAt    DateTime?
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  createdBy  User        @relation("SavedReports", fields: [createdById], references: [id], onDelete: Cascade)
  runs       ReportRun[]

  @@index([campgroundId])
  @@index([createdById])
}

model ReportRun {
  id          String    @id @default(cuid())
  reportId    String
  status      String // pending, running, completed, failed
  startedAt   DateTime?
  completedAt DateTime?
  rowCount    Int?
  fileUrl     String? // S3/storage URL
  error       String?
  triggeredBy String? // schedule | manual | user_id
  createdAt   DateTime  @default(now())

  report SavedReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId, createdAt])
}

model CohortAnalysis {
  id              String   @id @default(cuid())
  campgroundId    String
  cohortType      String // first_booking_month, acquisition_channel, site_type
  cohortValue     String
  periodStart     DateTime @db.Date
  periodEnd       DateTime @db.Date
  guestCount      Int
  bookings        Int
  revenue         Int // cents
  repeatRate      Float?
  avgBookingValue Int?
  createdAt       DateTime @default(now())

  @@unique([campgroundId, cohortType, cohortValue, periodStart])
  @@index([campgroundId, cohortType])
}

// --- Phase 3E: Multi-Property & Portfolio ---

model PortfolioDashboard {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  layout      Json // widget positions and configs
  isDefault   Boolean  @default(false)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("PortfolioDashboards", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([orgId])
}

model PortfolioMetric {
  id            String   @id @default(cuid())
  orgId         String
  campgroundId  String?
  metricDate    DateTime @db.Date
  metricType    String // occupancy, revenue, adr, revpar, bookings
  value         Float
  previousValue Float?
  changePercent Float?
  createdAt     DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  campground   Campground?  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([orgId, campgroundId, metricDate, metricType])
  @@index([orgId, metricDate])
}

model CentralizedRatePush {
  id            String    @id @default(cuid())
  orgId         String
  name          String
  rateConfig    Json // rate adjustments to push
  targetCampIds String[]
  status        String    @default("draft") // draft, pending, applied, failed
  appliedAt     DateTime?
  appliedBy     String?
  results       Json? // per-campground results
  createdBy     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
}

// ---------------------------------------------------------------------------
// Phase 4: Stored Value / POS / Analytics Facts
// ---------------------------------------------------------------------------

enum StoredValueType {
  gift
  credit
}

enum StoredValueStatus {
  active
  frozen
  expired
}

enum StoredValueDirection {
  issue
  redeem
  adjust
  expire
  refund
  hold_create
  hold_capture
  hold_release
}

enum StoredValueHoldStatus {
  open
  captured
  released
  expired
}

model StoredValueAccount {
  id               String             @id @default(cuid())
  campgroundId     String
  type             StoredValueType
  currency         String
  status           StoredValueStatus  @default(active)
  issuedAt         DateTime
  expiresAt        DateTime?
  liabilityAccount String?
  createdBy        String?
  createdVia       String?
  metadata         Json?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  campground Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  codes      StoredValueCode[]
  ledger     StoredValueLedger[]
  holds      StoredValueHold[]

  @@index([campgroundId])
  @@index([status])
}

model StoredValueCode {
  id                   String   @id @default(cuid())
  accountId            String
  code                 String   @unique
  pinHash              String?
  active               Boolean  @default(true)
  redeemedByGuestId    String?
  createdAt            DateTime @default(now())

  account StoredValueAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  guest   Guest?             @relation(fields: [redeemedByGuestId], references: [id], onDelete: SetNull)

  @@index([accountId])
}

model StoredValueLedger {
  id                  String              @id @default(cuid())
  campgroundId        String
  accountId           String
  direction           StoredValueDirection
  amountCents         Int
  currency            String
  beforeBalanceCents  Int
  afterBalanceCents   Int
  referenceType       String
  referenceId         String
  idempotencyKey      String
  actorType           String?
  actorId             String?
  channel             String?
  reason              String?
  createdAt           DateTime            @default(now())

  campground Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  account    StoredValueAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([campgroundId, idempotencyKey])
  @@index([accountId, createdAt])
}

model StoredValueHold {
  id             String                 @id @default(cuid())
  accountId      String
  amountCents    Int
  status         StoredValueHoldStatus  @default(open)
  expiresAt      DateTime
  referenceType  String
  referenceId    String
  idempotencyKey String
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  account StoredValueAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, status])
}

enum PosCartStatus {
  open
  checked_out
  void
}

enum PosPaymentMethod {
  card
  cash
  gift
  store_credit
  charge_to_site
}

enum PosPaymentStatus {
  pending
  succeeded
  failed
  refunded
}

enum TillSessionStatus {
  open
  closed
}

enum TillMovementType {
  cash_sale
  cash_refund
  paid_in
  paid_out
  adjustment
}

model PosTerminal {
  id             String   @id @default(cuid())
  campgroundId   String
  locationId     String?
  offlineCapable Boolean  @default(false)
  taxVersion     String?
  priceVersion   String?
  createdAt      DateTime @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  carts      PosCart[]

  @@index([campgroundId])
}

model PosCart {
  id           String         @id @default(cuid())
  campgroundId String
  terminalId   String?
  status       PosCartStatus  @default(open)
  needsReview  Boolean        @default(false)
  netCents     Int            @default(0)
  taxCents     Int            @default(0)
  feeCents     Int            @default(0)
  grossCents   Int            @default(0)
  currency     String
  taxVersion   String?
  priceVersion String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  terminal   PosTerminal? @relation(fields: [terminalId], references: [id], onDelete: SetNull)
  items      PosCartItem[]
  payments   PosPayment[]
  returns    PosReturn[]   @relation("ReturnCart")

  @@index([campgroundId, status])
  @@index([terminalId])
}

model PosCartItem {
  id              String   @id @default(cuid())
  cartId          String
  productId       String
  qty             Int
  unitPriceCents  Int
  discountCents   Int      @default(0)
  taxCents        Int      @default(0)
  feeCents        Int      @default(0)
  totalCents      Int
  metadata        Json?

  cart    PosCart  @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([cartId])
  @@index([productId])
}

model PosPayment {
  id             String           @id @default(cuid())
  cartId         String
  method         PosPaymentMethod
  amountCents    Int
  currency       String
  status         PosPaymentStatus @default(pending)
  idempotencyKey String
  referenceType  String?
  referenceId    String?
  processorIds   Json?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  cart PosCart @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@index([idempotencyKey])
}

model TillSession {
  id                 String            @id @default(cuid())
  campgroundId       String
  terminalId         String?
  status             TillSessionStatus @default(open)
  openingFloatCents  Int               @default(0)
  expectedCloseCents Int               @default(0)
  countedCloseCents  Int?
  overShortCents     Int               @default(0)
  currency           String
  notes              String?
  openedByUserId     String
  closedByUserId     String?
  openedAt           DateTime          @default(now())
  closedAt           DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  terminal   PosTerminal? @relation(fields: [terminalId], references: [id], onDelete: SetNull)
  openedBy   User         @relation("TillSessionOpenedBy", fields: [openedByUserId], references: [id], onDelete: Cascade)
  closedBy   User?        @relation("TillSessionClosedBy", fields: [closedByUserId], references: [id], onDelete: SetNull)
  movements  TillMovement[]

  @@index([campgroundId, status])
  @@index([terminalId, status])
}

model TillMovement {
  id            String           @id @default(cuid())
  sessionId     String
  type          TillMovementType
  amountCents   Int
  currency      String
  sourceCartId  String?
  actorUserId   String
  note          String?
  createdAt     DateTime @default(now())

  session TillSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  actor   User        @relation(fields: [actorUserId], references: [id], onDelete: Cascade)
  cart    PosCart?    @relation(fields: [sourceCartId], references: [id], onDelete: SetNull)

  @@index([sessionId, type])
  @@index([sourceCartId])
}

enum PosReturnStatus {
  pending
  completed
  failed
}

model PosReturn {
  id            String          @id @default(cuid())
  originalCartId String
  status        PosReturnStatus @default(pending)
  reasonCode    String?
  restock       Boolean         @default(false)
  netCents      Int             @default(0)
  taxCents      Int             @default(0)
  feeCents      Int             @default(0)
  grossCents    Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  originalCart PosCart @relation("ReturnCart", fields: [originalCartId], references: [id], onDelete: Cascade)

  @@index([originalCartId])
}

// Analytics daily facts
model FactReservationsDaily {
  id              String   @id @default(cuid())
  campgroundId    String
  metricDate      DateTime @db.Date
  roomsAvailable  Int
  roomsSold       Int
  roomRevenueCents Int
  taxesCents      Int       @default(0)
  feesCents       Int       @default(0)
  discountsCents  Int       @default(0)
  channel         String?
  createdAt       DateTime  @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, metricDate, channel])
  @@index([campgroundId, metricDate])
}

model FactPosDaily {
  id             String   @id @default(cuid())
  campgroundId   String
  locationId     String?
  metricDate     DateTime @db.Date
  netCents       Int
  taxCents       Int      @default(0)
  feeCents       Int      @default(0)
  discountsCents Int      @default(0)
  categoryId     String?
  createdAt      DateTime @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, metricDate, categoryId])
  @@index([campgroundId, metricDate])
}

model FactStoredValueDaily {
  id            String   @id @default(cuid())
  campgroundId  String
  metricDate    DateTime @db.Date
  issuedCents   Int      @default(0)
  redeemedCents Int      @default(0)
  expiredCents  Int      @default(0)
  createdAt     DateTime @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, metricDate])
  @@index([campgroundId, metricDate])
}
